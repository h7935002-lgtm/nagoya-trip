<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åå¤å±‹ãƒ»ç™½å·é„‰å†¬æ—… (V28)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* --- UI è¨­å®š --- */
        :root { --primary-color: #5856D6; --bg-color: #F5F5FA; --card-bg: #FFFFFF; --danger-color: #FF3B30; --success-color: #34C759; --text-dark: #1C1C1E; --text-gray: #8E8E93; --line-color: #E5E5EA; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; padding-top: 180px; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; color: var(--text-dark); }

        /* Header */
        .header { background: var(--primary-color); padding: 15px 20px 0px 20px; border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; color: white; box-shadow: 0 4px 20px rgba(88, 86, 214, 0.4); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
        .header-top-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .trip-title { font-size: 20px; font-weight: 800; letter-spacing: 0.5px; line-height: 1.2; border-bottom: 1px dashed transparent; }
        .trip-subtitle { font-size: 13px; opacity: 0.8; margin-top: 4px; font-weight: 500; border-bottom: 1px dashed transparent; display: inline-block; cursor: pointer;}
        
        .controls { display: flex; gap: 6px; }
        .view-btn { width: 34px; height: 34px; border-radius: 10px; border: none; background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; font-size: 15px; cursor: pointer; transition: 0.2s; }
        .view-btn.active { background: white; color: var(--primary-color); font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .edit-toggle { height: 34px; padding: 0 10px; border-radius: 10px; border: none; background: rgba(0,0,0,0.2); color: white; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .edit-toggle.editing { background: var(--success-color); }

        /* Tabs */
        .tabs-container { padding-bottom: 15px; overflow: hidden; }
        .tabs { display: flex; overflow-x: auto; gap: 10px; scrollbar-width: none; padding: 4px; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab-btn { background: rgba(255,255,255,0.15); border: none; color: rgba(255,255,255,0.8); padding: 8px 0; border-radius: 14px; width: 60px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: white; color: var(--primary-color); font-weight: bold; transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); color: var(--primary-color) !important; }
        .tab-date { font-size: 10px; margin-bottom: 2px; } .tab-day { font-size: 16px; font-weight: 800; }
        .sub-tabs { display: none; justify-content: flex-start; gap: 10px; padding: 4px; }
        .sub-tab-btn { background: rgba(0,0,0,0.2); color: rgba(255,255,255,0.8); border: none; padding: 8px 20px; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .sub-tab-btn.active { background: white; color: var(--primary-color); }

        /* Content */
        .content { padding: 10px 20px; min-height: 300px; display: none; }
        .content.active { display: block; animation: fadeIn 0.3s; }

        /* Timeline Items */
        .timeline-item { position: relative; padding-left: 35px; margin-bottom: 20px; overflow: visible !important; }
        .timeline-item::before { content: ''; position: absolute; left: 16px; top: 25px; bottom: -45px; width: 2px; background: var(--line-color); }
        .timeline-item:last-child::before { display: none; }
        .timeline-item::after { content: ''; position: absolute; left: 9px; top: 25px; width: 12px; height: 12px; background: var(--primary-color); border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 2px var(--primary-color); z-index: 2; }
        
        .card { background: var(--card-bg); border-radius: 20px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02); display: flex; gap: 15px; position: relative; overflow: visible !important; }
        
        /* Elements controlled by JS Inline Style now */
        .delete-btn { position: absolute; right: -10px; top: -10px; width: 26px; height: 26px; background: var(--danger-color); color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3); cursor: pointer; z-index: 9999; font-size: 14px; border: 2px solid white; }
        .drag-handle { position: absolute; left: -35px; top: 50%; transform: translateY(-50%); color: #CCC; font-size: 20px; padding: 10px; cursor: grab; z-index: 5; display: none; font-weight: bold; }
        .add-btn-container { text-align: center; margin-top: 20px; display: none; }
        .add-btn { background: var(--primary-color); color: white; border: none; padding: 12px 30px; border-radius: 30px; font-size: 15px; font-weight: 600; box-shadow: 0 4px 10px rgba(88,86,214,0.3); }
        .type-select { margin-top: 6px; width: 100%; font-size: 11px; display: none; border: 1px solid #ddd; padding: 4px; border-radius: 6px; }
        .type-badge { margin-top: 6px; padding: 3px 8px; border-radius: 8px; font-size: 10px; background: #F2F2F7; display: inline-block;}

        /* Edit Mode Helpers */
        body.is-editing .info-title, body.is-editing .info-loc span, body.is-editing .info-note, body.is-editing .time { border-bottom: 1px dashed #999; background: rgba(255,255,0,0.1); min-width: 20px; }

        /* Time & Info */
        .time-col { display: flex; flex-direction: column; align-items: center; min-width: 65px; border-right: 1px dashed #EEE; padding-right: 15px; padding-top: 5px; }
        .ampm { font-size: 11px; color: var(--text-gray); }
        .time { font-size: 18px; font-weight: 800; color: var(--text-dark); letter-spacing: -0.5px; }
        .info-col { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        .info-title { font-size: 16px; font-weight: 700; color: var(--text-dark); line-height: 1.3; }
        .info-loc { font-size: 12px; color: var(--text-gray); display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        .nav-btn { background: rgba(88, 86, 214, 0.1); color: var(--primary-color); padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; text-decoration: none; display: inline-flex; align-items: center; gap: 2px; }
        .info-note { font-size: 13px; color: #FF9500; font-weight: 500; margin-top: 2px; }
        .memo-box { margin-top: 8px; background: #FFF9E6; border-left: 3px solid #FFCC00; padding: 8px; border-radius: 6px; font-size: 12px; color: #665C3B; display: none; white-space: pre-wrap;}
        .memo-box.show { display: block; }

        /* Checklist */
        .checklist-container { padding: 10px 20px; }
        .checklist-category { background: white; border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); position: relative;}
        .cat-title { font-weight: 700; color: var(--primary-color); border-bottom: 1px solid #EEE; padding-bottom: 8px; margin-bottom: 8px; display:flex; justify-content:space-between;}
        .check-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #FAFAFA; }
        .custom-checkbox { width: 20px; height: 20px; border: 2px solid #DDD; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .check-item.checked .custom-checkbox { background: var(--success-color); border-color: var(--success-color); }
        .check-item.checked .custom-checkbox i { color: white; font-size: 10px; display: block; }
        .custom-checkbox i { display: none; }
        .check-item.checked .item-text { text-decoration: line-through; color: #CCC; }
        
        .del-check-btn, .del-cat-btn, .add-check-row, .add-cat-btn { display: none; }
        .add-cat-btn { width: 100%; text-align: center; padding: 15px; background: white; border: 2px dashed #DDD; border-radius: 12px; color: #AAA; margin-top: 10px; cursor: pointer;}
        .del-check-btn { color: var(--danger-color); margin-left: auto; cursor: pointer; font-weight:bold; padding:0 10px;}
        .del-cat-btn { position: absolute; top: 15px; right: 15px; color: #ccc; font-size: 12px; cursor: pointer; }
        .add-check-btn { color: var(--link-color); font-size: 13px; padding-top: 5px; cursor: pointer; text-align: center;}

        /* Expense & Notes Grid */
        .expense-summary { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; text-align: center; }
        .total-amount { font-size: 32px; font-weight: 800; color: var(--primary-color); margin: 10px 0; }
        .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 16px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .expense-input-row { display: flex; gap: 10px; margin-bottom: 20px; }
        .exp-input { flex: 1; padding: 12px; border: 1px solid #DDD; border-radius: 12px; font-size: 14px; }
        .exp-select { padding: 10px; border: 1px solid #DDD; border-radius: 12px; background: white; }
        .notes-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 5px; max-height: 60vh; overflow-y: auto; }
        .note-card { background: #FFF9C4; border-radius: 12px; padding: 15px; min-height: 120px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; }
        .note-del-btn { position: absolute; top: 5px; right: 5px; width: 20px; height: 20px; background: rgba(0,0,0,0.1); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer;}

        /* Modals & Editor */
        #note-editor-view { display: none; flex-direction: column; height: 100%; }
        .editor-toolbar { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .editor-toolbar button { background: none; border: none; color: var(--primary-color); font-weight: 600; font-size: 16px; cursor: pointer; }
        .note-textarea { width: 100%; flex: 1; border: none; background: #FFFDF0; padding: 20px; font-size: 16px; line-height: 1.6; border-radius: 15px; resize: none; box-sizing: border-box; min-height: 400px; outline: none; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 400px; max-height: 85vh; display: flex; flex-direction: column; position: relative;}
        .modal-title { font-size: 18px; font-weight: 800; margin-bottom: 20px; text-align: center; color: var(--text-dark); }
        .close-icon { position: absolute; top: 15px; right: 15px; font-size: 28px; color: #999; cursor: pointer; padding: 5px; z-index: 3001; }
        .modal-btn { width: 100%; padding: 12px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; margin-top: 15px; background: var(--primary-color); color: white;}
        .modal-btn.secondary { background: #E5E5EA; color: #333; }
        
        #status-indicator { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 30px; font-size: 12px; z-index: 2000; display: none; }
        #status-indicator.show { display: block; }
        .sortable-ghost { opacity: 0.4; background: #EEE; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top-row">
            <div class="title-group">
                <div class="trip-title" contenteditable="false" onblur="updateTitle(this.innerText)">ğŸ‡¯ğŸ‡µ åå¤å±‹ãƒ»ç™½å·é„‰ (V28)</div>
                <div class="trip-subtitle" onclick="openDatePicker()">DEC 05 - DEC 09, 2025</div>
            </div>
            <div class="controls">
                <button id="btn-view-itinerary" class="view-btn active" onclick="switchView('itinerary')"><i class="far fa-calendar-alt"></i></button>
                <button id="btn-view-checklist" class="view-btn" onclick="switchView('checklist')"><i class="fas fa-tasks"></i></button>
                <button id="btn-view-expenses" class="view-btn" onclick="switchView('expenses')"><i class="fas fa-yen-sign"></i></button>
                <button id="btn-view-notes" class="view-btn" onclick="switchView('notes')"><i class="fas fa-sticky-note"></i></button>
                <button id="btn-settings" class="view-btn" onclick="openSettings()"><i class="fas fa-cog"></i></button>
                <button class="edit-toggle" onclick="toggleEditMode()"><i class="fas fa-pen"></i></button>
            </div>
        </div>
        <div class="tabs-container">
            <div id="tabs-itinerary" class="tabs"></div>
            <div id="tabs-checklist" class="sub-tabs">
                <button class="sub-tab-btn active" onclick="switchChecklistType('pre', this)">ğŸ  è¡Œå‰æº–å‚™</button>
                <button class="sub-tab-btn" onclick="switchChecklistType('tour', this)">ğŸ§³ æ—…éŠæ¸…å–®</button>
            </div>
            <div id="tabs-expenses" class="sub-tabs" style="display:none; justify-content:center; color:white; font-size:14px; opacity:0.8;">
                ğŸ’° æ—…éŠè¨˜å¸³å°å¹«æ‰‹
            </div>
            <div id="tabs-notes" class="sub-tabs" style="display:none; justify-content:center; color:white; font-size:14px; opacity:0.8;">
                ğŸ“ éš¨èº«ç­†è¨˜ç‰†
            </div>
        </div>
    </div>

    <div id="container-itinerary" class="content active">
        <div id="schedule-container"></div>
        <div class="add-btn-container"><button class="add-btn" onclick="addNewItem()">ï¼‹ æ–°å¢è¡Œç¨‹</button></div>
    </div>

    <div id="container-checklist" class="content">
        <div id="checklist-container"></div>
        <div class="add-cat-btn" onclick="addNewCategory()">ï¼‹ æ–°å¢ä¸€å€‹å¤§åˆ†é¡</div>
    </div>

    <div id="container-expenses" class="content">
        <div class="expense-summary">
            <div class="total-sub">ç¸½æ”¯å‡º (æŠ˜åˆå°å¹£)</div>
            <div class="total-amount" id="total-twd">NT$ 0</div>
            <div class="rate-setting" onclick="updateExchangeRate()">ç›®å‰åŒ¯ç‡: <span id="current-rate">0.22</span> (é»æ“Šä¿®æ”¹)</div>
        </div>
        <div class="expense-input-row">
            <input type="text" id="exp-name" class="exp-input" placeholder="é …ç›®">
            <input type="number" id="exp-amount" class="exp-input" placeholder="é‡‘é¡" style="width:80px;">
            <select id="exp-curr" class="exp-select"><option value="JPY">JPY</option><option value="TWD">TWD</option></select>
            <button class="add-btn" style="margin-top:0;" onclick="addExpense()">ï¼‹</button>
        </div>
        <div id="expenses-list"></div>
    </div>

    <div id="container-notes" class="content">
        <div id="notes-list-view">
            <div id="notes-grid-container" class="notes-grid"></div>
            <div style="text-align:center; margin-top:20px;">
                <button class="add-btn" onclick="createNewNote()">ï¼‹ æ–°å¢ç­†è¨˜</button>
            </div>
        </div>
        <div id="notes-editor-view" style="display:none;">
            <div class="editor-toolbar">
                <button onclick="closeNoteEditor()" style="font-size:16px;color:#888;">< è¿”å›</button>
                <button onclick="saveAndCloseNoteEditor()" style="font-size:16px;font-weight:bold;">å„²å­˜</button>
            </div>
            <textarea id="current-note-input" class="note-textarea" placeholder="è¼¸å…¥å…§å®¹..."></textarea>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay" onclick="if(event.target===this) closeSettings()">
        <div class="modal-box">
            <div class="modal-title">âš™ï¸ è¨­å®šèˆ‡å‚™ä»½</div>
            <span class="close-icon" onclick="closeSettings()">Ã—</span>
            <button class="modal-btn" onclick="downloadData()">ğŸ“¥ åŒ¯å‡ºå‚™ä»½</button>
            <div style="position:relative; margin-top:10px;">
                <button class="modal-btn secondary" onclick="document.getElementById('import-file').click()">ğŸ“¤ åŒ¯å…¥é‚„åŸ</button>
                <input type="file" id="import-file" style="display:none" onchange="uploadData(this)">
            </div>
        </div>
    </div>

    <div id="date-modal" class="modal-overlay" onclick="if(event.target===this) closeDatePicker()">
        <div class="modal-box">
            <div class="modal-title">è¨­å®šæ—…éŠæ—¥æœŸ</div>
            <span class="close-icon" onclick="closeDatePicker()">Ã—</span>
            <div style="margin-bottom:15px;"><label>é–‹å§‹</label><input type="date" id="input-start-date" style="width:100%;padding:10px;"></div>
            <div style="margin-bottom:15px;"><label>çµæŸ</label><input type="date" id="input-end-date" style="width:100%;padding:10px;"></div>
            <button class="modal-btn" onclick="saveDateRange()">ç¢ºå®š</button>
        </div>
    </div>

    <div id="tags-modal" class="modal-overlay" onclick="if(event.target===this) closeTagsManager()">
        <div class="modal-box">
            <div class="modal-title">ç®¡ç†æ¨™ç±¤é¸é …</div>
            <span class="close-icon" onclick="closeTagsManager()">Ã—</span>
            <div id="tags-list-container" style="max-height:300px;overflow-y:auto;border:1px solid #eee;border-radius:12px;margin:15px 0;"></div>
            <button class="modal-btn" onclick="closeTagsManager()">é—œé–‰</button>
        </div>
    </div>

    <div id="status-indicator"><i class="fas fa-sync fa-spin"></i> åŒæ­¥ä¸­...</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDTQeG0emT5pqRYwCebkyVyGttmy-t6crY",
            authDomain: "travel-d67d0.firebaseapp.com",
            projectId: "travel-d67d0",
            storageBucket: "travel-d67d0.firebasestorage.app",
            messagingSenderId: "223292356224",
            appId: "1:223292356224:web:5511095a095ffc4080d865"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tripDocRef = db.collection("trips").doc("nagoya_2025_trip_permanent"); 

        const defaultData = {
            meta: { title: "ğŸ‡¯ğŸ‡µ åå¤å±‹ãƒ»ç™½å·é„‰", subtitle: "DEC 05 - DEC 09, 2025", startDate: "2025-12-05", endDate: "2025-12-09", rate: 0.22 },
            notesList: [], expenses: [],
            itinerary: { d1: [{ id: 101, time: "11:00", type: "âœˆï¸ é£›è¡Œ", title: "æŠµé”æ¡ƒåœ’æ©Ÿå ´", loc: "æ©Ÿå ´", note: "", memo: "" }] },
            checklist_pre: [{ category: "å¿…å‚™è­‰ä»¶", items: [{ text: "è­·ç…§", checked: false }] }],
            checklist_tour: [{ category: "å¿…è²·", items: [{ text: "è—¥å¦", checked: false }] }],
            activityTypes: ["âœˆï¸ é£›è¡Œ", "ğŸš„ äº¤é€š", "ğŸ¡ æ™¯é»", "ğŸ´ ç”¨é¤", "ğŸ¨ ä½å®¿", "ğŸ›ï¸ è³¼ç‰©"]
        };

        let currentDay = 'd1';
        let currentChecklistType = 'pre';
        let isEditing = false;
        let appData = JSON.parse(JSON.stringify(defaultData));
        let sortableInstance = null;
        let currentEditingNoteId = null;

        window.onload = function() { initRealtimeSync(); };

        function initRealtimeSync() {
            showStatus("é€£ç·šä¸­...");
            tripDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const remoteData = doc.data();
                    if (!isEditing || !appData.itinerary) {
                        appData = remoteData;
                        if(!appData.notesList) appData.notesList = [];
                        if(!appData.expenses) appData.expenses = [];
                        if(!appData.meta) appData.meta = defaultData.meta;
                        if(!appData.activityTypes) appData.activityTypes = defaultData.activityTypes;
                        document.querySelector('.trip-title').innerText = appData.meta.title + ' (V28)';
                        document.querySelector('.trip-subtitle').innerText = appData.meta.subtitle;
                        if(document.getElementById('current-rate')) document.getElementById('current-rate').innerText = appData.meta.rate || 0.22;
                        renderTabs(); renderSchedule(); renderChecklist(); renderExpenses(); renderNotesGrid();
                    }
                    showStatus("å·²åŒæ­¥", false);
                    setTimeout(() => hideStatus(), 2000);
                } else { saveDataToCloud(true); }
            }, (error) => { console.error(error); showStatus("åŒæ­¥å¤±æ•—"); });
        }

        let saveTimeout;
        function triggerSave() {
            showStatus("å„²å­˜ä¸­...");
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => { saveDataToCloud(true); }, 1000);
        }

        function saveDataToCloud(force = false) {
            showStatus("å„²å­˜ä¸­...");
            tripDocRef.set(appData)
                .then(() => { showStatus("å·²å„²å­˜"); setTimeout(() => hideStatus(), 2000); })
                .catch((e) => showStatus("å„²å­˜å¤±æ•—"));
        }

        function openSettings() { document.getElementById('settings-modal').classList.add('show'); }
        function closeSettings() { document.getElementById('settings-modal').classList.remove('show'); }
        function downloadData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `trip_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
       function uploadData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if(confirm("ç¢ºå®šè¦é‚„åŸæ­¤å‚™ä»½å—ï¼Ÿç›®å‰ç•«é¢å°‡è¢«è¦†è“‹ã€‚")) {
                        appData = importedData;
                        if(!appData.meta) appData.meta = defaultData.meta;
                        if(!appData.notesList) appData.notesList = [];
                        document.querySelector('.trip-title').innerText = appData.meta.title;
                        document.querySelector('.trip-subtitle').innerText = appData.meta.subtitle;
                        if(document.getElementById('current-rate')) document.getElementById('current-rate').innerText = appData.meta.rate || 0.22;
                        renderTabs(); renderSchedule(); renderChecklist(); renderExpenses(); renderNotesGrid();
                        saveDataToCloud(true); 
                        alert("é‚„åŸæˆåŠŸï¼"); closeSettings(); 
                    }
                } catch(err) { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); console.error(err); }
            };
            reader.readAsText(file); input.value = '';
        }

        // --- Notes Logic ---
        function renderNotesGrid() {
            const container = document.getElementById('notes-grid-container'); container.innerHTML = '';
            if(!appData.notesList || appData.notesList.length === 0) { container.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;padding:20px;">å°šç„¡ç­†è¨˜</div>'; return; }
            appData.notesList.forEach(note => {
                const div = document.createElement('div'); div.className = 'note-card';
                div.onclick = function(e) { if(e.target.closest('.note-del-btn')) return; openNoteEditor(note.id); };
                
                // â˜…â˜…â˜… å¼·åˆ¶å¯«å…¥ inline style ç¢ºä¿æŒ‰éˆ•é¡¯ç¤º â˜…â˜…â˜…
                const delBtnStyle = isEditing ? 'display:flex !important;' : 'display:none;';
                
                div.innerHTML = `<div class="note-del-btn" style="${delBtnStyle}" onclick="deleteNote(${note.id})">Ã—</div><div class="note-preview">${note.content || "(ç©ºç™½)"}</div><div class="note-date">${note.date || ""}</div>`;
                container.appendChild(div);
            });
        }
        function createNewNote() { const id = Date.now(); appData.notesList.push({id: id, content: "", date: new Date().toLocaleDateString()}); triggerSave(); renderNotesGrid(); openNoteEditor(id); }
        function openNoteEditor(id) { 
            currentEditingNoteId = id; 
            const n = appData.notesList.find(x => x.id === id); 
            if(n) { 
                document.getElementById('current-note-input').value = n.content; 
                document.getElementById('notes-list-view').style.display = 'none';
                document.getElementById('notes-editor-view').style.display = 'flex';
            } 
        }
        function saveAndCloseNoteEditor() {
            if(currentEditingNoteId) {
                const idx = appData.notesList.findIndex(x => x.id === currentEditingNoteId);
                if(idx > -1) { appData.notesList[idx].content = document.getElementById('current-note-input').value; triggerSave(); }
            }
            closeNoteEditor();
        }
        function closeNoteEditor() { 
            document.getElementById('notes-editor-view').style.display = 'none';
            document.getElementById('notes-list-view').style.display = 'block';
            renderNotesGrid();
        }
        function deleteNote(id) { if(confirm("åˆªé™¤ï¼Ÿ")) { appData.notesList = appData.notesList.filter(x => x.id !== id); triggerSave(); renderNotesGrid(); } }

        // --- Views ---
        function switchView(view) {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-view-' + view).classList.add('active');
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById('container-' + view).classList.add('active');
            document.getElementById('tabs-itinerary').style.display = view === 'itinerary' ? 'flex' : 'none';
            document.getElementById('tabs-checklist').style.display = view === 'checklist' ? 'flex' : 'none';
            document.getElementById('tabs-expenses').style.display = view === 'expenses' ? 'flex' : 'none';
            document.getElementById('tabs-notes').style.display = view === 'notes' ? 'flex' : 'none';
        }

        // --- Tabs & Date ---
        const WEEKDAYS = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
        const MONTHS = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        function renderTabs() {
            const container = document.getElementById('tabs-itinerary'); container.innerHTML = '';
            const start = new Date(appData.meta.startDate); const end = new Date(appData.meta.endDate);
            const diffDays = Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24)) + 1;
            const startStr = `${MONTHS[start.getMonth()]} ${String(start.getDate()).padStart(2, '0')}`;
            const endStr = `${MONTHS[end.getMonth()]} ${String(end.getDate()).padStart(2, '0')}, ${end.getFullYear()}`;
            appData.meta.subtitle = `${startStr} - ${endStr}`;
            document.querySelector('.trip-subtitle').innerText = appData.meta.subtitle;
            for (let i = 0; i < diffDays; i++) {
                const dayId = `d${i + 1}`; const curr = new Date(start); curr.setDate(start.getDate() + i);
                const btn = document.createElement('button'); btn.className = `tab-btn ${currentDay === dayId ? 'active' : ''}`;
                btn.onclick = function () { switchDay(dayId, this); };
                btn.innerHTML = `<span class="tab-date">${WEEKDAYS[curr.getDay()]}</span><span class="tab-day">D${i + 1}</span>`;
                container.appendChild(btn);
            }
        }
        function openDatePicker() { if(!isEditing) return; document.getElementById('input-start-date').value = appData.meta.startDate; document.getElementById('input-end-date').value = appData.meta.endDate; document.getElementById('date-modal').classList.add('show'); }
        function closeDatePicker() { document.getElementById('date-modal').classList.remove('show'); }
        function saveDateRange() { 
            const s = document.getElementById('input-start-date').value; const e = document.getElementById('input-end-date').value;
            if(s && e) { appData.meta.startDate = s; appData.meta.endDate = e; currentDay='d1'; renderTabs(); renderSchedule(); saveDataToCloud(true); closeDatePicker(); }
        }

        function updateTitle(v) { appData.meta.title=v.trim(); triggerSave(); }
        function updateSubtitle(v) { appData.meta.subtitle=v.trim(); triggerSave(); }
        function addExpense() { const n=document.getElementById('exp-name').value; const a=parseFloat(document.getElementById('exp-amount').value); const c=document.getElementById('exp-curr').value; if(n&&a){appData.expenses.push({id:Date.now(), item:n, amount:a, curr:c}); document.getElementById('exp-name').value=''; document.getElementById('exp-amount').value=''; renderExpenses(); triggerSave();} }
        function deleteExpense(id) { if(confirm("åˆªé™¤ï¼Ÿ")){appData.expenses=appData.expenses.filter(x=>x.id!==id); renderExpenses(); triggerSave();} }
        function updateExchangeRate() { const r=prompt("åŒ¯ç‡:", appData.meta.rate); if(r&&!isNaN(r)){appData.meta.rate=parseFloat(r); document.getElementById('current-rate').innerText=r; renderExpenses(); triggerSave();} }
        function renderExpenses() { 
            const list=document.getElementById('expenses-list'); list.innerHTML=''; let total=0; const r=appData.meta.rate||0.22;
            appData.expenses.forEach(ex=>{ let eq=ex.curr==='TWD'?ex.amount:Math.round(ex.amount*r); total+=eq; list.innerHTML+=`<div class="expense-item"><div class="expense-info"><div class="expense-name">${ex.item} <span class="expense-currency">${ex.curr}</span></div></div><div style="text-align:right;"><div class="expense-price">${ex.curr==='TWD'?'NT$':'Â¥'} ${ex.amount}</div><div style="font-size:11px; color:#999;">â‰ˆ NT$ ${eq}</div></div><div style="margin-left:15px; color:#FF3B30; cursor:pointer;" onclick="deleteExpense(${ex.id})">Ã—</div></div>`; });
            document.getElementById('total-twd').innerText = `NT$ ${total.toLocaleString()}`;
        }
        function getPeriod(t) { if(!t||!t.includes(":"))return""; const h=parseInt(t.split(":")[0]); if(h<5)return"æ·±å¤œ"; if(h<11)return"ä¸Šåˆ"; if(h<14)return"ä¸­åˆ"; if(h<18)return"ä¸‹åˆ"; return"æ™šä¸Š"; }
        function renderTypeOptions(v) { let o=`<option value="">é¸æ“‡</option>`; appData.activityTypes.forEach(t=>{o+=`<option value="${t}" ${t===v?'selected':''}>${t}</option>`}); return o+`<option value="ADD_NEW">â• æ–°å¢...</option><option value="MANAGE_OPTION" style="color:var(--primary-color);">âš™ï¸ ç®¡ç†...</option>`; }
        function renderSchedule() {
            const container=document.getElementById('schedule-container'); container.innerHTML='';
            (appData.itinerary[currentDay]||[]).forEach((item, index) => {
                const div=document.createElement('div'); div.className='timeline-item'; div.setAttribute('data-index', index);
                let mapUrl=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((item.loc||"").replace(/ğŸ“|ğŸš—|ğŸš„|âœˆï¸/g,'').trim())}`;
                let hasMemo=(item.memo||"").length>0;
                
                // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šç›´æ¥åœ¨ HTML ä¸­å¯«å…¥ style ä¾†æ§åˆ¶é¡¯ç¤ºï¼Œç„¡è¦–å¤–éƒ¨ CSS è¡çª â˜…â˜…â˜…
                const delBtnStyle = isEditing ? 'display:flex !important;' : 'display:none;';
                const handleStyle = isEditing ? 'display:block !important;' : 'display:none;';
                const typeBadgeStyle = isEditing ? 'display:none !important;' : 'display:inline-block;';
                const typeSelectStyle = isEditing ? 'display:block !important;' : 'display:none;';
                
                div.innerHTML=`
                    <div class="drag-handle" style="${handleStyle}"><i class="fas fa-bars"></i></div>
                    <div class="card">
                        <div class="delete-btn" onclick="deleteItem(${index})" style="${delBtnStyle}">âœ•</div>
                        <div class="time-col">
                            <div class="ampm">${getPeriod(item.time)}</div>
                            <div class="time" onblur="updateTimeText(${index},this.innerText)">${item.time}</div>
                            <div class="type-badge" style="${typeBadgeStyle}">${item.type||""}</div>
                            <select class="type-select" style="${typeSelectStyle}" onchange="updateType(${index},this.value)">${renderTypeOptions(item.type||"")}</select>
                        </div>
                        <div class="info-col">
                            <div class="info-title" onblur="updateItinerary(${index},'title',this.innerText)">${item.title}</div>
                            <div class="info-loc"><span onblur="updateLoc(${index},this.innerText)">${item.loc}</span><a href="${mapUrl}" target="_blank" class="nav-btn"><i class="fas fa-location-arrow"></i> å°èˆª</a></div>
                            <div class="info-note" onblur="updateItinerary(${index},'note',this.innerText)">${item.note}</div>
                            <div class="memo-box ${hasMemo?'show':''}" onblur="updateItinerary(${index},'memo',this.innerText)">${item.memo||""}</div>
                            <div class="memo-controls" style="display:none;margin-top:5px;font-size:12px;"><span onclick="toggleMemo(${index})" style="color:#007AFF;cursor:pointer;">${hasMemo?'åˆªé™¤å‚™å¿˜':'æ–°å¢å‚™å¿˜'}</span></div>
                        </div>
                    </div>`;
                if(isEditing) div.querySelector('.memo-controls').style.display='block'; container.appendChild(div);
            });
            setEditable(isEditing);
            if(isEditing) { 
                if(sortableInstance) sortableInstance.destroy(); 
                sortableInstance = new Sortable(container, { handle:'.drag-handle', animation:150, onEnd: function(evt){ const list=appData.itinerary[currentDay]; list.splice(evt.newIndex, 0, list.splice(evt.oldIndex, 1)[0]); triggerSave(); } }); 
            }
        }
        function updateLoc(i, v) { if(appData.itinerary[currentDay][i]){ appData.itinerary[currentDay][i].loc=v.trim(); renderSchedule(); triggerSave(); } }
        function updateTimeText(i, v) { if(appData.itinerary[currentDay][i]){ appData.itinerary[currentDay][i].time=v.trim(); renderSchedule(); triggerSave(); } }
        function updateItinerary(i, k, v) { if(appData.itinerary[currentDay][i]){ appData.itinerary[currentDay][i][k]=v.trim(); triggerSave(); } }
        function toggleMemo(i) { const item=appData.itinerary[currentDay][i]; item.memo=item.memo?"":"å‚™å¿˜..."; renderSchedule(); triggerSave(); }
        function updateType(i, v) { if(v==="ADD_NEW"){const n=prompt("æ–°æ¨™ç±¤ï¼š"); if(n){appData.activityTypes.push(n); appData.itinerary[currentDay][i].type=n; saveDataToCloud(true); renderSchedule();} else renderSchedule();} else if(v==="MANAGE_OPTION"){openTagsManager(); renderSchedule();} else {appData.itinerary[currentDay][i].type=v; triggerSave();} }
        function renderChecklist() { const container=document.getElementById('checklist-container'); container.innerHTML=''; const list=currentChecklistType==='pre'?appData.checklist_pre:appData.checklist_tour; (list||[]).forEach((cat, ci)=>{ let h=''; cat.items.forEach((item, ii)=>{ h+=`<div class="check-item ${item.checked?'checked':''}"><div class="custom-checkbox" onclick="toggleCheck(${ci},${ii})"><i>âœ”</i></div><div class="item-text" onblur="updCheck(${ci},${ii},this.innerText)">${item.text}</div><div class="del-check-btn" onclick="delCheck(${ci},${ii})">âœ•</div></div>`; }); const div=document.createElement('div'); div.className='checklist-category'; div.innerHTML=`<div class="cat-title"><span onblur="updCat(${ci},this.innerText)">${cat.category}</span><span class="del-cat-btn" onclick="delCat(${ci})">åˆªé™¤</span></div><div>${h}</div><div class="add-check-row"><div class="add-check-btn" onclick="addCheck(${ci})">ï¼‹ æ–°å¢é …ç›®</div></div>`; container.appendChild(div); }); setEditable(isEditing); }
        function toggleCheck(ci, ii) { if(isEditing)return; const l=getList(); l[ci].items[ii].checked=!l[ci].items[ii].checked; renderChecklist(); triggerSave(); }
        function updCheck(ci, ii, v) { getList()[ci].items[ii].text=v.trim(); triggerSave(); }
        function updCat(ci, v) { getList()[ci].category=v.trim(); triggerSave(); }
        function delCheck(ci, ii) { if(confirm("åˆªé™¤ï¼Ÿ")){ getList()[ci].items.splice(ii,1); renderChecklist(); triggerSave(); }}
        function addCheck(ci) { getList()[ci].items.push({text:"æ–°é …ç›®", checked:false}); renderChecklist(); triggerSave(); }
        function delCat(ci) { if(confirm("åˆªé™¤åˆ†é¡ï¼Ÿ")){ getList().splice(ci,1); renderChecklist(); triggerSave(); }}
        function addNewCategory() { getList().push({category:"æ–°åˆ†é¡", items:[]}); renderChecklist(); triggerSave(); }
        function getList() { return currentChecklistType==='pre'?appData.checklist_pre:appData.checklist_tour; }
        
        function openTagsManager() { renderTagsList(); document.getElementById('tags-modal').classList.add('show'); }
        function closeTagsManager() { document.getElementById('tags-modal').classList.remove('show'); renderSchedule(); }
        function renderTagsList() { const c=document.getElementById('tags-list-container'); c.innerHTML=''; appData.activityTypes.forEach(t=>{ const d=document.createElement('div'); d.style.cssText='display:flex;justify-content:space-between;padding:12px;border-bottom:1px solid #eee;'; d.innerHTML=`<span>${t}</span><span style="color:red;cursor:pointer;" onclick="deleteTag('${t}')">âœ•</span>`; c.appendChild(d); }); }
        function deleteTag(t) { if(confirm("åˆªé™¤æ¨™ç±¤ï¼Ÿ")){ appData.activityTypes=appData.activityTypes.filter(x=>x!==t); saveDataToCloud(true); renderTagsList(); } }

        // --- Toggle Logic (Direct Style Manipulation) ---
        function toggleEditMode() {
            if(!isEditing && !sessionStorage.getItem('isAuth')) { const p=prompt("å¯†ç¢¼ï¼š"); if(p!=="8888"){alert("éŒ¯èª¤");return;} sessionStorage.setItem('isAuth','true'); }
            isEditing = !isEditing;
            document.querySelector('.edit-toggle').classList.toggle('editing', isEditing);
            document.querySelector('.trip-title').contentEditable = isEditing;
            document.querySelector('.trip-subtitle').style.cursor = isEditing ? "pointer" : "default";
            document.querySelector('.trip-subtitle').style.borderBottom = isEditing ? "1px dashed rgba(255,255,255,0.5)" : "none";
            
            // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šç›´æ¥æ“ä½œ style å±¬æ€§ï¼Œä¸ä¾è³´ CSS class â˜…â˜…â˜…
            const disp = isEditing ? 'block' : 'none';
            document.querySelectorAll('.add-btn-container').forEach(e => e.style.setProperty('display', disp, 'important'));
            document.querySelectorAll('.del-check-btn, .del-cat-btn, .add-check-row, .add-cat-btn').forEach(e => e.style.setProperty('display', disp, 'important'));

            setEditable(isEditing); renderSchedule(); renderChecklist(); renderNotesGrid();
        }
        
        function switchDay(d, b) { currentDay=d; document.querySelectorAll('#tabs-itinerary .tab-btn').forEach(e=>e.classList.remove('active')); b.classList.add('active'); renderSchedule(); }
        function switchChecklistType(t, b) { currentChecklistType=t; document.querySelectorAll('.sub-tab-btn').forEach(e=>e.classList.remove('active')); b.classList.add('active'); renderChecklist(); }
        function setEditable(e) { document.querySelectorAll('.info-title, .info-loc span, .info-note, .memo-box, .item-text, .cat-title span, .time').forEach(f => { f.contentEditable = e; }); }
        function addNewItem() { if(!appData.itinerary[currentDay]) appData.itinerary[currentDay]=[]; appData.itinerary[currentDay].push({id:Date.now(), time:"12:00", type:"âœˆï¸ é£›è¡Œ", title:"æ–°è¡Œç¨‹", loc:"åœ°é»", note:"", memo:""}); renderSchedule(); triggerSave(); }
        function deleteItem(i) { if(confirm('åˆªé™¤ï¼Ÿ')){ appData.itinerary[currentDay].splice(i,1); renderSchedule(); triggerSave(); }}
        function showStatus(m, e){ const el=document.getElementById('status-indicator'); el.innerText=m; el.classList.add('show'); if(e) el.style.background='red'; else el.style.background='rgba(0,0,0,0.8)'; }
        function hideStatus(){ document.getElementById('status-indicator').classList.remove('show'); }
        document.addEventListener('paste', function (e) { if (e.target.isContentEditable) { e.preventDefault(); const t = (e.clipboardData || window.clipboardData).getData('text'); document.execCommand('insertText', false, t); } });
    </script>
</body>
</html>