<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åå¤å±‹ãƒ»ç™½å·é„‰å†¬æ—…</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* --- V12.0 UI é¢¨æ ¼è¨­å®š --- */
        :root {
            --primary-color: #5856D6; /* iOS Deep Purple */
            --bg-color: #F5F5FA;
            --card-bg: #FFFFFF;
            --danger-color: #FF3B30;
            --success-color: #34C759;
            --text-dark: #1C1C1E;
            --text-gray: #8E8E93;
            --line-color: #E5E5EA;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0; padding-bottom: 100px;
            -webkit-tap-highlight-color: transparent;
            color: var(--text-dark);
        }

        /* --- Header (ä»¿æˆªåœ–é¢¨æ ¼) --- */
        .header {
            background: var(--primary-color);
            padding: 20px 20px 15px 20px;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            color: white;
            box-shadow: 0 4px 15px rgba(88, 86, 214, 0.3);
            position: sticky; top: 0; z-index: 100;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .trip-title { font-size: 24px; font-weight: 800; letter-spacing: 0.5px; }
        
        /* ç·¨è¼¯æŒ‰éˆ• */
        .edit-toggle {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; gap: 6px; backdrop-filter: blur(5px);
        }
        .edit-toggle.editing { background: var(--success-color); border-color: transparent; }

        /* æ—¥æœŸ Tabs */
        .tabs { display: flex; overflow-x: auto; gap: 12px; padding-bottom: 5px; scrollbar-width: none; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab-btn {
            background: rgba(255,255,255,0.15); border: none; color: rgba(255,255,255,0.9);
            padding: 10px 0; border-radius: 14px; width: 60px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; flex-shrink: 0;
        }
        .tab-btn.active {
            background: white; color: var(--primary-color); font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: scale(1.05);
        }
        .tab-date { font-size: 11px; margin-bottom: 2px; opacity: 0.8; }
        .tab-day { font-size: 18px; font-weight: 700; }

        /* æ¬¡ç´šåˆ†é  (æ¸…å–®) */
        .sub-tabs { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .sub-tab-btn { background: rgba(0,0,0,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 6px 16px; border-radius: 20px; font-size: 13px; cursor: pointer; }
        .sub-tab-btn.active { background: white; color: var(--primary-color); font-weight: bold; }

        /* --- æ™‚é–“è»¸å…§å®¹å€ --- */
        .content { padding: 25px 20px; min-height: 300px; }
        .timeline-item { position: relative; padding-left: 20px; margin-bottom: 25px; }
        
        /* å·¦å´ç·šæ¢ */
        .timeline-item::before {
            content: ''; position: absolute; left: 9px; top: 25px; bottom: -45px;
            width: 2px; background: var(--line-color);
        }
        .timeline-item:last-child::before { display: none; }
        /* å·¦å´åœ“é» */
        .timeline-item::after {
            content: ''; position: absolute; left: 2px; top: 25px;
            width: 12px; height: 12px; background: var(--primary-color);
            border-radius: 50%; border: 2px solid white;
            box-shadow: 0 0 0 2px var(--primary-color); z-index: 2;
        }

        /* å¡ç‰‡è¨­è¨ˆ */
        .card {
            background: var(--card-bg); border-radius: 20px; padding: 20px 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02);
            display: flex; gap: 15px; position: relative;
        }

        /* å·¦å´æ™‚é–“å€å¡Š */
        .time-col {
            display: flex; flex-direction: column; align-items: center;
            min-width: 65px; border-right: 1px dashed #EEE; padding-right: 15px;
            justify-content: flex-start; padding-top: 2px;
        }
        .ampm { font-size: 11px; color: var(--text-gray); font-weight: 500; margin-bottom: 2px; }
        .time { font-size: 20px; font-weight: 800; color: var(--text-dark); letter-spacing: -0.5px; }
        
        /* æ–°åŠŸèƒ½ï¼šé¡å‹æ¨™ç±¤ (Badge/Dropdown) */
        .type-badge {
            margin-top: 8px; padding: 4px 8px; border-radius: 12px;
            font-size: 11px; font-weight: 600; color: #555; background: #F0F0F5;
            display: inline-block; white-space: nowrap;
        }
        .type-select {
            margin-top: 8px; padding: 2px; font-size: 11px; border-radius: 6px; border: 1px solid #ccc;
            width: 100%; max-width: 70px; display: none; /* é è¨­éš±è— */
        }
        body.is-editing .type-badge { display: none; }
        body.is-editing .type-select { display: block; }

        /* å³å´è³‡è¨Šå€å¡Š */
        .info-col { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        .info-title { font-size: 17px; font-weight: 700; color: var(--text-dark); line-height: 1.3; }
        .info-loc { font-size: 13px; color: var(--text-gray); display: flex; align-items: center; gap: 5px; }
        .info-note { font-size: 13px; color: #FF9500; font-weight: 500; margin-top: 2px; }

        /* å°èˆªæŒ‰éˆ• */
        .nav-btn {
            background: rgba(88, 86, 214, 0.1); color: var(--primary-color);
            padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;
            text-decoration: none; display: inline-flex; align-items: center; gap: 3px;
        }

        /* Memo */
        .memo-box {
            margin-top: 10px; background: #FFF9E6; border-left: 3px solid #FFCC00;
            padding: 10px; border-radius: 8px; font-size: 13px; color: #665C3B;
            display: none; width: 100%; line-height: 1.5;
        }
        .memo-box.show { display: block; }
        
        /* ç·¨è¼¯ç›¸é—œ */
        .drag-handle { position: absolute; left: -30px; top: 25px; color: #CCC; font-size: 18px; display: none; cursor: grab; }
        body.is-editing .drag-handle { display: block; }
        body.is-editing .delete-btn { display: flex; }
        .delete-btn {
            position: absolute; right: -8px; top: -8px;
            width: 24px; height: 24px; background: var(--danger-color); color: white;
            border-radius: 50%; display: none; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; z-index: 10;
        }

        /* åº•éƒ¨å°èˆª */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: white; border-top: 1px solid #EEE;
            display: flex; justify-content: space-around; align-items: center; z-index: 900;
            padding-bottom: 10px; /* é©é… iPhone Home Bar */
        }
        .nav-item {
            flex: 1; text-align: center; color: #C7C7CC;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            cursor: pointer; transition: 0.2s;
        }
        .nav-item i { font-size: 22px; }
        .nav-item span { font-size: 10px; font-weight: 600; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item.active i { transform: translateY(-2px); }

        /* å…¶ä»–é€šç”¨ */
        .page-view { display: none; }
        .page-view.active { display: block; animation: fadeIn 0.3s; }
        .add-btn-container { text-align: center; margin-top: 10px; display: none; }
        body.is-editing .add-btn-container { display: block; }
        .add-btn { background: var(--primary-color); color: white; border: none; padding: 12px 25px; border-radius: 30px; font-size: 14px; font-weight: 600; box-shadow: 0 4px 12px rgba(88,86,214,0.3); }
        
        /* ç·¨è¼¯æ¡†æç¤º */
        body.is-editing .info-title, body.is-editing .info-loc, body.is-editing .info-note, body.is-editing .time {
            border-bottom: 1px dashed #CCC; background: rgba(0,0,0,0.02); min-width: 20px;
        }

        #status-indicator { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 30px; font-size: 12px; z-index: 1000; display: none; }
        #status-indicator.show { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* æ¸…å–®æ¨£å¼ä¿ç•™ */
        .checklist-container { padding: 20px; }
        .checklist-category { background: white; border-radius: 16px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .cat-title { font-weight: 700; color: var(--primary-color); border-bottom: 1px solid #EEE; padding-bottom: 8px; margin-bottom: 8px; display:flex; justify-content:space-between;}
        .check-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #FAFAFA; }
        .custom-checkbox { width: 20px; height: 20px; border: 2px solid #DDD; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .check-item.checked .custom-checkbox { background: var(--success-color); border-color: var(--success-color); }
        .check-item.checked .custom-checkbox i { color: white; font-size: 10px; display: block; }
        .custom-checkbox i { display: none; }
        .check-item.checked .item-text { text-decoration: line-through; color: #CCC; }
        
        /* æ¸…å–®ç·¨è¼¯æŒ‰éˆ• */
        .del-check-btn, .del-cat-btn, .add-check-row, .add-cat-btn { display: none; }
        body.is-editing .del-check-btn, body.is-editing .del-cat-btn, body.is-editing .add-check-row, body.is-editing .add-cat-btn { display: block; }
        .add-cat-btn { width: 100%; text-align: center; padding: 15px; background: white; border: 2px dashed #DDD; border-radius: 12px; color: #AAA; margin-top: 20px; cursor: pointer;}
        .del-check-btn { color: var(--danger-color); margin-left: auto; cursor: pointer; }
        .add-check-btn { color: var(--link-color); font-size: 13px; padding-top: 10px; cursor: pointer; text-align: center;}
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top">
            <div class="trip-title" contenteditable="false">ğŸ‡¯ğŸ‡µ åå¤å±‹ãƒ»ç™½å·é„‰</div>
            <div class="edit-toggle" onclick="toggleEditMode()">
                <i class="fas fa-pen"></i> <span id="editBtnText">ç·¨è¼¯</span>
            </div>
        </div>
        
        <div id="itinerary-tabs" class="tabs">
            <button class="tab-btn active" onclick="switchDay('d1', this)"><span class="tab-date">é€±å››</span><span class="tab-day">D1</span></button>
            <button class="tab-btn" onclick="switchDay('d2', this)"><span class="tab-date">é€±äº”</span><span class="tab-day">D2</span></button>
            <button class="tab-btn" onclick="switchDay('d3', this)"><span class="tab-date">é€±å…­</span><span class="tab-day">D3</span></button>
            <button class="tab-btn" onclick="switchDay('d4', this)"><span class="tab-date">é€±æ—¥</span><span class="tab-day">D4</span></button>
            <button class="tab-btn" onclick="switchDay('d5', this)"><span class="tab-date">é€±ä¸€</span><span class="tab-day">D5</span></button>
            <button class="tab-btn" onclick="switchDay('d6', this)"><span class="tab-date">é€±äºŒ</span><span class="tab-day">D6</span></button>
        </div>
        
        <div id="checklist-tabs" class="sub-tabs" style="display:none;">
            <button class="sub-tab-btn active" onclick="switchChecklistType('pre', this)">ğŸ  è¡Œå‰æº–å‚™</button>
            <button class="sub-tab-btn" onclick="switchChecklistType('tour', this)">ğŸ§³ æ—…éŠæ¸…å–®</button>
        </div>
    </div>

    <div id="view-itinerary" class="page-view active">
        <div class="content" id="schedule-container"></div>
        <div class="add-btn-container"><button class="add-btn" onclick="addNewItem()">ï¼‹ æ–°å¢è¡Œç¨‹</button></div>
    </div>

    <div id="view-checklist" class="page-view">
        <div class="checklist-container" id="checklist-container"></div>
        <div class="checklist-container"><div class="add-cat-btn" onclick="addNewCategory()">ï¼‹ æ–°å¢ä¸€å€‹å¤§åˆ†é¡</div></div>
    </div>

    <div id="status-indicator"><i class="fas fa-sync fa-spin"></i> åŒæ­¥ä¸­...</div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('itinerary', this)">
            <i class="fas fa-map-marked-alt"></i><span>è¡Œç¨‹</span>
        </div>
        <div class="nav-item" onclick="switchPage('checklist', this)">
            <i class="fas fa-clipboard-check"></i><span>æ¸…å–®</span>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // --- è¨­å®š (Firebase Config) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDTQeG0emT5pqRYwCebkyVyGttmy-t6crY",
            authDomain: "travel-d67d0.firebaseapp.com",
            projectId: "travel-d67d0",
            storageBucket: "travel-d67d0.firebasestorage.app",
            messagingSenderId: "223292356224",
            appId: "1:223292356224:web:5511095a095ffc4080d865"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tripDocRef = db.collection("trips").doc("nagoya_2025_trip_v12"); 

        // é è¨­è³‡æ–™ (å«æ–°çš„æ¨™ç±¤é¸é …)
        const defaultData = {
            itinerary: {
                d1: [{ id: 101, time: "11:00", type: "âœˆï¸ é£›è¡Œ", title: "æŠµé”æ¡ƒåœ’æ©Ÿå ´", loc: "æ©Ÿå ´", note: "", memo: "" }],
                d2: [], d3: [], d4: [], d5: [], d6: []
            },
            checklist_pre: [{ category: "å¿…å‚™è­‰ä»¶", items: [{ text: "è­·ç…§", checked: false }] }],
            checklist_tour: [{ category: "å¿…è²·", items: [{ text: "è—¥å¦", checked: false }] }],
            // å¯è‡ªå®šç¾©çš„æ´»å‹•æ¨™ç±¤
            activityTypes: ["âœˆï¸ é£›è¡Œ", "ğŸš„ äº¤é€š", "ğŸ¡ æ™¯é»", "ğŸ´ ç”¨é¤", "ğŸ¨ ä½å®¿", "ğŸ›ï¸ è³¼ç‰©"]
        };

        let currentDay = 'd1';
        let currentChecklistType = 'pre';
        let isEditing = false;
        let appData = JSON.parse(JSON.stringify(defaultData));
        let sortableInstance = null;

        window.onload = function() { initRealtimeSync(); };

        function initRealtimeSync() {
            showStatus("é€£ç·šä¸­...");
            tripDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const remoteData = doc.data();
                    if (!isEditing || !appData.itinerary) {
                        appData = remoteData;
                        // ç¢ºä¿æ–°æ¬„ä½å­˜åœ¨
                        if(!appData.activityTypes) appData.activityTypes = defaultData.activityTypes;
                        renderSchedule(); renderChecklist();
                    }
                    showStatus("å·²åŒæ­¥", false);
                    setTimeout(() => hideStatus(), 2000);
                } else { saveDataToCloud(true); }
            }, (error) => { console.error(error); showStatus("åŒæ­¥å¤±æ•—"); });
        }

        function saveDataToCloud(force = false) {
            if (isEditing && !force) return;
            showStatus("å„²å­˜ä¸­...");
            tripDocRef.set(appData)
                .then(() => { showStatus("å·²å„²å­˜"); setTimeout(() => hideStatus(), 2000); })
                .catch((e) => showStatus("å„²å­˜å¤±æ•—"));
        }

        // --- æ ¸å¿ƒï¼šæ™ºæ…§æ™‚é–“åˆ¤æ–· ---
        function getPeriod(timeStr) {
            if(!timeStr || !timeStr.includes(":")) return "";
            const h = parseInt(timeStr.split(":")[0]);
            if (h < 5) return "æ·±å¤œ";
            if (h < 11) return "ä¸Šåˆ";
            if (h < 14) return "ä¸­åˆ";
            if (h < 18) return "ä¸‹åˆ";
            return "æ™šä¸Š";
        }

        // --- æ ¸å¿ƒï¼šä¸‹æ‹‰é¸å–®ç”Ÿæˆ ---
        function renderTypeOptions(currentVal) {
            let opts = `<option value="">é¸æ“‡é¡å‹</option>`;
            appData.activityTypes.forEach(t => {
                const sel = t === currentVal ? 'selected' : '';
                opts += `<option value="${t}" ${sel}>${t}</option>`;
            });
            opts += `<option value="ADD_NEW">â• æ–°å¢é¸é …...</option>`;
            return opts;
        }

        // --- æ¸²æŸ“è¡Œç¨‹ ---
        function renderSchedule() {
            const container = document.getElementById('schedule-container');
            container.innerHTML = '';
            const dayList = appData.itinerary[currentDay] || [];

            dayList.forEach((item, index) => {
                // è‡ªå‹•è¨ˆç®—æ™‚æ®µ
                const period = getPeriod(item.time);
                
                // è™•ç†åœ°é»å°èˆª
                let cleanLoc = item.loc ? item.loc.replace(/ğŸ“|ğŸš—|ğŸš„|âœˆï¸/g, '').trim() : "";
                let mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(cleanLoc)}`;
                
                // Memo é¡¯ç¤º
                let hasMemo = (item.memo || "").length > 0;
                let memoClass = hasMemo ? "show" : "";
                
                // é¡å‹æ¨™ç±¤ (è‹¥ç„¡å‰‡é è¨­ç‚ºç¬¬ä¸€å€‹)
                let typeVal = item.type || "";
                
                const div = document.createElement('div');
                div.className = 'timeline-item';
                div.setAttribute('data-index', index);
                
                div.innerHTML = `
                    <div class="drag-handle"><i class="fas fa-bars"></i></div>
                    <div class="card">
                        <div class="delete-btn" onclick="deleteItem(${index})"><i class="fas fa-times"></i></div>
                        
                        <div class="time-col">
                            <div class="ampm">${period}</div>
                            <div class="time" onblur="updateTimeText(${index}, this.innerText)">${item.time}</div>
                            
                            <div class="type-badge">${typeVal}</div>
                            <select class="type-select" onchange="updateType(${index}, this.value)">
                                ${renderTypeOptions(typeVal)}
                            </select>
                        </div>

                        <div class="info-col">
                            <div class="info-title" onblur="updateItinerary(${index}, 'title', this.innerText)">${item.title}</div>
                            <div class="info-loc">
                                <span onblur="updateItinerary(${index}, 'loc', this.innerText)">${item.loc}</span>
                                <a href="${mapUrl}" target="_blank" class="nav-btn"><i class="fas fa-location-arrow"></i> å°èˆª</a>
                            </div>
                            <div class="info-note" onblur="updateItinerary(${index}, 'note', this.innerText)">${item.note}</div>
                            
                            <div class="memo-box ${memoClass}" onblur="updateItinerary(${index}, 'memo', this.innerText)">${item.memo || ""}</div>
                            <div class="memo-controls" style="display:none; margin-top:5px; font-size:12px;">
                                <span onclick="toggleMemo(${index})" style="color:#007AFF; cursor:pointer;">${hasMemo?'åˆªé™¤å‚™å¿˜':'æ–°å¢å‚™å¿˜'}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                // ç·¨è¼¯æ¨¡å¼é¡¯ç¤ºå‚™å¿˜æŒ‰éˆ•
                if(isEditing) div.querySelector('.memo-controls').style.display = 'block';
                
                container.appendChild(div);
            });
            setEditable(isEditing);

            if (isEditing) {
                if (sortableInstance) sortableInstance.destroy();
                sortableInstance = new Sortable(container, {
                    handle: '.drag-handle', animation: 150,
                    onEnd: function (evt) {
                        const list = appData.itinerary[currentDay];
                        const item = list.splice(evt.oldIndex, 1)[0];
                        list.splice(evt.newIndex, 0, item);
                    }
                });
            }
        }

        // --- äº’å‹•é‚è¼¯ ---
        function updateTimeText(i, val) {
            val = val.trim();
            if(appData.itinerary[currentDay][i]) {
                appData.itinerary[currentDay][i].time = val;
                // å¼·åˆ¶é‡ç¹ªä»¥æ›´æ–° AM/PM
                renderSchedule();
            }
        }
        function updateItinerary(i, k, v) { if(appData.itinerary[currentDay][i]) appData.itinerary[currentDay][i][k] = v.trim(); }
        function toggleMemo(i) {
            const item = appData.itinerary[currentDay][i];
            item.memo = item.memo ? "" : "å‚™å¿˜...";
            renderSchedule();
        }
        
        // è™•ç†é¡å‹é¸æ“‡ & æ–°å¢é¸é …
        function updateType(index, val) {
            if (val === "ADD_NEW") {
                const newType = prompt("è«‹è¼¸å…¥æ–°æ¨™ç±¤åç¨± (å»ºè­°åŠ  emojiï¼Œä¾‹å¦‚: ğŸœ æ‹‰éºµ)ï¼š");
                if (newType && newType.trim() !== "") {
                    appData.activityTypes.push(newType.trim());
                    appData.itinerary[currentDay][index].type = newType.trim();
                    // é€™è£¡è¦ç«‹åˆ»å­˜æª”ï¼Œå› ç‚º activityTypes æ”¹è®Šäº†
                    saveDataToCloud(true);
                    renderSchedule();
                } else {
                    // å–æ¶ˆå‰‡å›å¾©åŸç‹€
                    renderSchedule();
                }
            } else {
                appData.itinerary[currentDay][index].type = val;
            }
        }

        // --- æ¸…å–®é‚è¼¯ ---
        function renderChecklist() {
            const container = document.getElementById('checklist-container');
            container.innerHTML = '';
            const targetList = currentChecklistType === 'pre' ? appData.checklist_pre : appData.checklist_tour;
            (targetList || []).forEach((cat, ci) => {
                let itemsHtml = '';
                cat.items.forEach((item, ii) => {
                    itemsHtml += `<div class="check-item ${item.checked?'checked':''}"><div class="custom-checkbox" onclick="toggleCheck(${ci},${ii})"><i>âœ”</i></div><div class="item-text" onblur="updCheck(${ci},${ii},this.innerText)">${item.text}</div><div class="del-check-btn" onclick="delCheck(${ci},${ii})">âœ•</div></div>`;
                });
                const div = document.createElement('div');
                div.className = 'checklist-category';
                div.innerHTML = `<div class="cat-title"><span onblur="updCat(${ci},this.innerText)">${cat.category}</span><span class="del-cat-btn" onclick="delCat(${ci})">åˆªé™¤</span></div><div>${itemsHtml}</div><div class="add-check-row"><div class="add-check-btn" onclick="addCheck(${ci})">ï¼‹ æ–°å¢é …ç›®</div></div>`;
                container.appendChild(div);
            });
            setEditable(isEditing);
        }
        function toggleCheck(ci, ii) { if(isEditing) return; const l=getList(); l[ci].items[ii].checked=!l[ci].items[ii].checked; renderChecklist(); saveDataToCloud(true); }
        function updCheck(ci, ii, v) { getList()[ci].items[ii].text = v.trim(); }
        function updCat(ci, v) { getList()[ci].category = v.trim(); }
        function delCheck(ci, ii) { if(confirm('åˆªé™¤ï¼Ÿ')){ getList()[ci].items.splice(ii,1); renderChecklist(); }}
        function addCheck(ci) { getList()[ci].items.push({text:"æ–°é …ç›®", checked:false}); renderChecklist(); }
        function delCat(ci) { if(confirm('åˆªé™¤åˆ†é¡ï¼Ÿ')){ getList().splice(ci,1); renderChecklist(); }}
        function addNewCategory() { getList().push({category:"æ–°åˆ†é¡", items:[]}); renderChecklist(); }
        function getList() { return currentChecklistType === 'pre' ? appData.checklist_pre : appData.checklist_tour; }

        // --- é€šç”¨åˆ‡æ› ---
        function toggleEditMode() {
            if (!isEditing) {
                const pwd = "8888"; 
                if (!sessionStorage.getItem('isAuth')) {
                    const input = prompt("è«‹è¼¸å…¥ç·¨è¼¯å¯†ç¢¼ï¼š");
                    if (input !== pwd) { alert("å¯†ç¢¼éŒ¯èª¤"); return; }
                    sessionStorage.setItem('isAuth', 'true');
                }
            } else { saveDataToCloud(true); }
            isEditing = !isEditing;
            const btn = document.querySelector('.edit-toggle');
            document.body.classList.toggle('is-editing', isEditing);
            btn.classList.toggle('editing', isEditing);
            btn.innerHTML = isEditing ? '<i class="fas fa-check"></i> å®Œæˆ' : '<i class="fas fa-pen"></i> ç·¨è¼¯';
            setEditable(isEditing);
            renderSchedule(); renderChecklist();
        }
        
        function switchDay(d, b) { currentDay=d; document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); b.classList.add('active'); renderSchedule(); }
        function switchChecklistType(t, b) { currentChecklistType=t; document.querySelectorAll('.sub-tab-btn').forEach(e=>e.classList.remove('active')); b.classList.add('active'); renderChecklist(); }
        function switchPage(p, b) {
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); b.classList.add('active');
            document.querySelectorAll('.page-view').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+p).classList.add('active');
            if(p==='itinerary') { document.getElementById('itinerary-tabs').style.display='flex'; document.getElementById('checklist-tabs').style.display='none'; }
            else { document.getElementById('itinerary-tabs').style.display='none'; document.getElementById('checklist-tabs').style.display='flex'; }
        }
        function setEditable(e) { document.querySelectorAll('.info-title, .info-loc, .info-note, .memo-box, .item-text, .cat-title span, .time').forEach(f => { f.contentEditable = e; }); }
        function addNewItem() { if(!appData.itinerary[currentDay]) appData.itinerary[currentDay]=[]; appData.itinerary[currentDay].push({id:Date.now(), time:"12:00", type:"âœˆï¸ é£›è¡Œ", title:"æ–°è¡Œç¨‹", loc:"åœ°é»", note:"", memo:""}); renderSchedule(); }
        function deleteItem(i) { if(confirm('åˆªé™¤ï¼Ÿ')){ appData.itinerary[currentDay].splice(i,1); renderSchedule(); }}
        function showStatus(m, e){ const el=document.getElementById('status-indicator'); el.innerText=m; el.classList.add('show'); if(e) el.style.background='red'; else el.style.background='rgba(0,0,0,0.8)'; }
        function hideStatus(){ document.getElementById('status-indicator').classList.remove('show'); }
        document.addEventListener('paste', function (e) { if (e.target.isContentEditable) { e.preventDefault(); const t = (e.clipboardData || window.clipboardData).getData('text'); document.execCommand('insertText', false, t); } });
    </script>
</body>
</html>
