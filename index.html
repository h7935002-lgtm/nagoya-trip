<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åå¤å±‹ãƒ»ç™½å·é„‰å†¬æ—…</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* --- V14.0 UI è¨­å®š --- */
        :root {
            --primary-color: #5856D6; /* iOS Deep Purple */
            --primary-dark: #4a48b8;
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --danger-color: #FF3B30;
            --success-color: #34C759;
            --text-dark: #1C1C1E;
            --text-gray: #8E8E93;
            --line-color: #E5E5EA;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            padding-top: 180px; /* ç•™çµ¦ Header çš„ç©ºé–“ */
            padding-bottom: 40px;
            -webkit-tap-highlight-color: transparent;
            color: var(--text-dark);
        }

        /* --- Fixed Header (å¤§æ”¹ç‰ˆ) --- */
        .header {
            background: var(--primary-color);
            padding: 15px 20px 0px 20px; /* åº•éƒ¨paddingç”±tabsæ’é–‹ */
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            color: white;
            box-shadow: 0 4px 20px rgba(88, 86, 214, 0.4);
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            transition: height 0.3s;
        }

        /* ä¸ŠåŠéƒ¨ï¼šæ¨™é¡Œèˆ‡åˆ‡æ›æŒ‰éˆ• */
        .header-top-row {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 15px;
        }

        /* æ¨™é¡Œå€ */
        .title-group { flex: 1; margin-right: 10px; }
        .trip-title { 
            font-size: 24px; font-weight: 800; letter-spacing: 0.5px; line-height: 1.2;
            border-bottom: 1px dashed transparent; 
        }
        .trip-subtitle { 
            font-size: 13px; opacity: 0.8; margin-top: 4px; font-weight: 500;
            border-bottom: 1px dashed transparent; display: inline-block;
        }
        /* ç·¨è¼¯æ¨¡å¼ä¸‹æ¨™é¡Œé¡¯ç¤ºè™›ç·š */
        body.is-editing .trip-title, body.is-editing .trip-subtitle {
            border-bottom: 1px dashed rgba(255,255,255,0.5); background: rgba(0,0,0,0.1); border-radius: 4px; padding: 0 4px;
        }

        /* å³ä¸Šè§’æ§åˆ¶å€ (åˆ‡æ›è¦–åœ– + ç·¨è¼¯) */
        .controls { display: flex; gap: 8px; }
        
        /* è¦–åœ–åˆ‡æ›æŒ‰éˆ• (ä»¿æˆªåœ– Icon) */
        .view-btn {
            width: 36px; height: 36px; border-radius: 12px; border: none;
            background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.7);
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; cursor: pointer; transition: 0.2s;
        }
        .view-btn.active {
            background: white; color: var(--primary-color); font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* ç·¨è¼¯æŒ‰éˆ• */
        .edit-toggle {
            height: 36px; padding: 0 12px; border-radius: 12px; border: none;
            background: rgba(0,0,0,0.2); color: white; font-size: 13px; font-weight: 600;
            display: flex; align-items: center; gap: 5px; cursor: pointer;
        }
        .edit-toggle.editing { background: var(--success-color); }

        /* --- ä¸‹åŠéƒ¨ï¼šTabs å€åŸŸ --- */
        .tabs-container { padding-bottom: 15px; overflow: hidden; }
        
        /* è¡Œç¨‹ Tabs (Day 1...) */
        .tabs { display: flex; overflow-x: auto; gap: 10px; scrollbar-width: none; padding: 4px; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab-btn {
            background: rgba(255,255,255,0.15); border: none; color: rgba(255,255,255,0.8);
            padding: 8px 0; border-radius: 14px; width: 60px; flex-shrink: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .tab-btn.active {
            background: white; color: var(--primary-color); font-weight: bold;
            transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); color: var(--primary-color) !important;
        }
        .tab-date { font-size: 10px; margin-bottom: 2px; }
        .tab-day { font-size: 16px; font-weight: 800; }

        /* æ¸…å–® Tabs (è¡Œå‰/æ—…éŠ) */
        .sub-tabs { display: none; justify-content: flex-start; gap: 10px; padding: 4px; }
        .sub-tab-btn {
            background: rgba(0,0,0,0.2); color: rgba(255,255,255,0.8); border: none;
            padding: 8px 20px; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer;
        }
        .sub-tab-btn.active { background: white; color: var(--primary-color); }

        /* --- å…§å®¹å€ --- */
        .content { padding: 10px 20px; min-height: 300px; display: none; }
        .content.active { display: block; animation: fadeIn 0.3s; }

        /* Timeline æ¨£å¼ (ç¶­æŒ V13) */
        .timeline-item { position: relative; padding-left: 20px; margin-bottom: 20px; }
        .timeline-item::before { content: ''; position: absolute; left: 9px; top: 25px; bottom: -45px; width: 2px; background: var(--line-color); }
        .timeline-item:last-child::before { display: none; }
        .timeline-item::after { content: ''; position: absolute; left: 2px; top: 25px; width: 12px; height: 12px; background: var(--primary-color); border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 2px var(--primary-color); z-index: 2; }

        .card {
            background: var(--card-bg); border-radius: 20px; padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02);
            display: flex; gap: 15px; position: relative;
        }

        /* æ¨£å¼ç´°ç¯€ */
        .time-col { display: flex; flex-direction: column; align-items: center; min-width: 65px; border-right: 1px dashed #EEE; padding-right: 15px; padding-top: 5px; }
        .ampm { font-size: 11px; color: var(--text-gray); font-weight: 500; }
        .time { font-size: 18px; font-weight: 800; color: var(--text-dark); letter-spacing: -0.5px; }
        
        .type-badge { margin-top: 6px; padding: 3px 8px; border-radius: 8px; font-size: 10px; font-weight: 600; color: #666; background: #F2F2F7; }
        .type-select { margin-top: 6px; width: 100%; font-size: 11px; display: none; }
        body.is-editing .type-badge { display: none; }
        body.is-editing .type-select { display: block; }

        .info-col { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        .info-title { font-size: 16px; font-weight: 700; color: var(--text-dark); line-height: 1.3; }
        .info-loc { font-size: 12px; color: var(--text-gray); display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        .nav-btn { background: rgba(88, 86, 214, 0.1); color: var(--primary-color); padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; text-decoration: none; display: inline-flex; align-items: center; gap: 2px; }
        
        .memo-box { margin-top: 8px; background: #FFF9E6; border-left: 3px solid #FFCC00; padding: 8px; border-radius: 6px; font-size: 12px; color: #665C3B; display: none; }
        .memo-box.show { display: block; }

        /* ç·¨è¼¯ä»‹é¢ */
        .drag-handle { position: absolute; left: -25px; top: 50%; transform: translateY(-50%); color: #CCC; font-size: 16px; display: none; cursor: grab; padding: 10px;}
        body.is-editing .drag-handle { display: block; }
        
        .delete-btn { position: absolute; right: -8px; top: -8px; width: 22px; height: 22px; background: var(--danger-color); color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; z-index: 10; font-size: 12px;}
        body.is-editing .delete-btn { display: flex; }

        /* æ¸…å–®æ¨£å¼ */
        .checklist-container { padding: 10px 20px; }
        .checklist-category { background: white; border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .cat-title { font-weight: 700; color: var(--primary-color); border-bottom: 1px solid #EEE; padding-bottom: 8px; margin-bottom: 8px; display:flex; justify-content:space-between;}
        .check-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #FAFAFA; }
        .custom-checkbox { width: 20px; height: 20px; border: 2px solid #DDD; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .check-item.checked .custom-checkbox { background: var(--success-color); border-color: var(--success-color); }
        .check-item.checked .custom-checkbox i { color: white; font-size: 10px; display: block; }
        .custom-checkbox i { display: none; }
        .check-item.checked .item-text { text-decoration: line-through; color: #CCC; }

        /* ç·¨è¼¯æç¤ºæ¡† */
        body.is-editing .info-title, body.is-editing .info-loc span, body.is-editing .info-note, body.is-editing .time { border-bottom: 1px dashed #CCC; background: rgba(0,0,0,0.02); min-width: 20px; }
        
        /* éš±è—/é¡¯ç¤ºæ§åˆ¶ */
        .del-check-btn, .del-cat-btn, .add-check-row, .add-cat-btn, .add-btn-container { display: none; }
        body.is-editing .del-check-btn, body.is-editing .del-cat-btn, body.is-editing .add-check-row, body.is-editing .add-cat-btn, body.is-editing .add-btn-container { display: block; }
        
        .add-btn { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 30px; font-size: 13px; font-weight: 600; box-shadow: 0 4px 10px rgba(88,86,214,0.3); margin-top: 10px; }
        .add-cat-btn { width: 100%; text-align: center; padding: 15px; background: white; border: 2px dashed #DDD; border-radius: 12px; color: #AAA; margin-top: 10px; cursor: pointer;}
        .del-check-btn { color: var(--danger-color); margin-left: auto; cursor: pointer; }
        .add-check-btn { color: var(--link-color); font-size: 13px; padding-top: 5px; cursor: pointer; text-align: center;}

        #status-indicator { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 30px; font-size: 12px; z-index: 2000; display: none; }
        #status-indicator.show { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top-row">
            <div class="title-group">
                <div class="trip-title" contenteditable="false" onblur="updateTitle(this.innerText)">ğŸ‡¯ğŸ‡µ åå¤å±‹ãƒ»ç™½å·é„‰</div>
                <div class="trip-subtitle" contenteditable="false" onblur="updateSubtitle(this.innerText)">DEC 05 - DEC 09, 2025</div>
            </div>
            <div class="controls">
                <button id="btn-view-itinerary" class="view-btn active" onclick="switchView('itinerary')">
                    <i class="far fa-calendar-alt"></i>
                </button>
                <button id="btn-view-checklist" class="view-btn" onclick="switchView('checklist')">
                    <i class="fas fa-tasks"></i>
                </button>
                <button class="edit-toggle" onclick="toggleEditMode()">
                    <i class="fas fa-pen"></i>
                </button>
            </div>
        </div>
        
        <div class="tabs-container">
            <div id="tabs-itinerary" class="tabs">
                <button class="tab-btn active" onclick="switchDay('d1', this)"><span class="tab-date">é€±å››</span><span class="tab-day">D1</span></button>
                <button class="tab-btn" onclick="switchDay('d2', this)"><span class="tab-date">é€±äº”</span><span class="tab-day">D2</span></button>
                <button class="tab-btn" onclick="switchDay('d3', this)"><span class="tab-date">é€±å…­</span><span class="tab-day">D3</span></button>
                <button class="tab-btn" onclick="switchDay('d4', this)"><span class="tab-date">é€±æ—¥</span><span class="tab-day">D4</span></button>
                <button class="tab-btn" onclick="switchDay('d5', this)"><span class="tab-date">é€±ä¸€</span><span class="tab-day">D5</span></button>
                <button class="tab-btn" onclick="switchDay('d6', this)"><span class="tab-date">é€±äºŒ</span><span class="tab-day">D6</span></button>
            </div>
            
            <div id="tabs-checklist" class="sub-tabs">
                <button class="sub-tab-btn active" onclick="switchChecklistType('pre', this)">ğŸ  è¡Œå‰æº–å‚™</button>
                <button class="sub-tab-btn" onclick="switchChecklistType('tour', this)">ğŸ§³ æ—…éŠæ¸…å–®</button>
            </div>
        </div>
    </div>

    <div id="container-itinerary" class="content active">
        <div id="schedule-container"></div>
        <div class="add-btn-container"><button class="add-btn" onclick="addNewItem()">ï¼‹ æ–°å¢è¡Œç¨‹</button></div>
    </div>

    <div id="container-checklist" class="content">
        <div id="checklist-container"></div>
        <div class="add-cat-btn" onclick="addNewCategory()">ï¼‹ æ–°å¢ä¸€å€‹å¤§åˆ†é¡</div>
    </div>

    <div id="status-indicator"><i class="fas fa-sync fa-spin"></i> åŒæ­¥ä¸­...</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDTQeG0emT5pqRYwCebkyVyGttmy-t6crY",
            authDomain: "travel-d67d0.firebaseapp.com",
            projectId: "travel-d67d0",
            storageBucket: "travel-d67d0.firebasestorage.app",
            messagingSenderId: "223292356224",
            appId: "1:223292356224:web:5511095a095ffc4080d865"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tripDocRef = db.collection("trips").doc("nagoya_2025_trip_v14"); 

        const defaultData = {
            meta: { title: "ğŸ‡¯ğŸ‡µ åå¤å±‹ãƒ»ç™½å·é„‰", subtitle: "DEC 05 - DEC 09, 2025" },
            itinerary: { d1: [{ id: 101, time: "11:00", type: "âœˆï¸ é£›è¡Œ", title: "æŠµé”æ¡ƒåœ’æ©Ÿå ´", loc: "æ©Ÿå ´", note: "", memo: "" }], d2: [], d3: [], d4: [], d5: [], d6: [] },
            checklist_pre: [{ category: "å¿…å‚™è­‰ä»¶", items: [{ text: "è­·ç…§", checked: false }] }],
            checklist_tour: [{ category: "å¿…è²·", items: [{ text: "è—¥å¦", checked: false }] }],
            activityTypes: ["âœˆï¸ é£›è¡Œ", "ğŸš„ äº¤é€š", "ğŸ¡ æ™¯é»", "ğŸ´ ç”¨é¤", "ğŸ¨ ä½å®¿", "ğŸ›ï¸ è³¼ç‰©"]
        };

        let currentDay = 'd1';
        let currentChecklistType = 'pre';
        let isEditing = false;
        let appData = JSON.parse(JSON.stringify(defaultData));
        let sortableInstance = null;

        window.onload = function() { initRealtimeSync(); };

        function initRealtimeSync() {
            showStatus("é€£ç·šä¸­...");
            tripDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const remoteData = doc.data();
                    if (!isEditing || !appData.itinerary) {
                        appData = remoteData;
                        if(!appData.meta) appData.meta = defaultData.meta;
                        if(!appData.activityTypes) appData.activityTypes = defaultData.activityTypes;
                        
                        // æ›´æ–°æ¨™é¡Œ
                        document.querySelector('.trip-title').innerText = appData.meta.title;
                        document.querySelector('.trip-subtitle').innerText = appData.meta.subtitle;
                        
                        renderSchedule(); renderChecklist();
                    }
                    showStatus("å·²åŒæ­¥", false);
                    setTimeout(() => hideStatus(), 2000);
                } else { saveDataToCloud(true); }
            }, (error) => { console.error(error); showStatus("åŒæ­¥å¤±æ•—"); });
        }

        function saveDataToCloud(force = false) {
            if (isEditing && !force) return;
            showStatus("å„²å­˜ä¸­...");
            tripDocRef.set(appData)
                .then(() => { showStatus("å·²å„²å­˜"); setTimeout(() => hideStatus(), 2000); })
                .catch((e) => showStatus("å„²å­˜å¤±æ•—"));
        }

        // --- View Switching ---
        function switchView(view) {
            // åˆ‡æ›æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-view-' + view).classList.add('active');
            
            // åˆ‡æ›å…§å®¹èˆ‡ Tabs
            if (view === 'itinerary') {
                document.getElementById('container-itinerary').classList.add('active');
                document.getElementById('container-checklist').classList.remove('active');
                document.getElementById('tabs-itinerary').style.display = 'flex';
                document.getElementById('tabs-checklist').style.display = 'none';
            } else {
                document.getElementById('container-itinerary').classList.remove('active');
                document.getElementById('container-checklist').classList.add('active');
                document.getElementById('tabs-itinerary').style.display = 'none';
                document.getElementById('tabs-checklist').style.display = 'flex';
            }
        }

        // --- Title / Subtitle Editing ---
        function updateTitle(val) { appData.meta.title = val.trim(); saveDataToCloud(true); }
        function updateSubtitle(val) { appData.meta.subtitle = val.trim(); saveDataToCloud(true); }

        // --- Core Logic ---
        function getPeriod(timeStr) {
            if(!timeStr || !timeStr.includes(":")) return "";
            const h = parseInt(timeStr.split(":")[0]);
            if (h < 5) return "æ·±å¤œ"; if (h < 11) return "ä¸Šåˆ"; if (h < 14) return "ä¸­åˆ"; if (h < 18) return "ä¸‹åˆ"; return "æ™šä¸Š";
        }

        function renderTypeOptions(currentVal) {
            let opts = `<option value="">é¸æ“‡é¡å‹</option>`;
            appData.activityTypes.forEach(t => {
                const sel = t === currentVal ? 'selected' : '';
                opts += `<option value="${t}" ${sel}>${t}</option>`;
            });
            opts += `<option value="ADD_NEW">â• æ–°å¢é¸é …...</option>`;
            opts += `<option value="DEL_OPTION" style="color:red;">â– åˆªé™¤é¸é …...</option>`;
            return opts;
        }

        function renderSchedule() {
            const container = document.getElementById('schedule-container');
            container.innerHTML = '';
            const dayList = appData.itinerary[currentDay] || [];

            dayList.forEach((item, index) => {
                const period = getPeriod(item.time);
                let cleanLoc = item.loc ? item.loc.replace(/ğŸ“|ğŸš—|ğŸš„|âœˆï¸/g, '').trim() : "";
                let mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(cleanLoc)}`;
                let hasMemo = (item.memo || "").length > 0;
                let memoClass = hasMemo ? "show" : "";
                let typeVal = item.type || "";
                
                const div = document.createElement('div');
                div.className = 'timeline-item';
                div.setAttribute('data-index', index);
                
                div.innerHTML = `
                    <div class="drag-handle"><i class="fas fa-bars"></i></div>
                    <div class="card">
                        <div class="delete-btn" onclick="deleteItem(${index})"><i class="fas fa-times"></i></div>
                        <div class="time-col">
                            <div class="ampm">${period}</div>
                            <div class="time" onblur="updateTimeText(${index}, this.innerText)">${item.time}</div>
                            <div class="type-badge">${typeVal}</div>
                            <select class="type-select" onchange="updateType(${index}, this.value)">${renderTypeOptions(typeVal)}</select>
                        </div>
                        <div class="info-col">
                            <div class="info-title" onblur="updateItinerary(${index}, 'title', this.innerText)">${item.title}</div>
                            <div class="info-loc">
                                <span onblur="updateLoc(${index}, this.innerText)">${item.loc}</span>
                                <a href="${mapUrl}" target="_blank" class="nav-btn"><i class="fas fa-location-arrow"></i> å°èˆª</a>
                            </div>
                            <div class="info-note" onblur="updateItinerary(${index}, 'note', this.innerText)">${item.note}</div>
                            <div class="memo-box ${memoClass}" onblur="updateItinerary(${index}, 'memo', this.innerText)">${item.memo || ""}</div>
                            <div class="memo-controls" style="display:none; margin-top:5px; font-size:12px;">
                                <span onclick="toggleMemo(${index})" style="color:#007AFF; cursor:pointer;">${hasMemo?'åˆªé™¤å‚™å¿˜':'æ–°å¢å‚™å¿˜'}</span>
                            </div>
                        </div>
                    </div>
                `;
                if(isEditing) div.querySelector('.memo-controls').style.display = 'block';
                container.appendChild(div);
            });
            setEditable(isEditing);

            if (isEditing) {
                if (sortableInstance) sortableInstance.destroy();
                sortableInstance = new Sortable(container, {
                    handle: '.drag-handle', animation: 150,
                    onEnd: function (evt) {
                        const list = appData.itinerary[currentDay];
                        const item = list.splice(evt.oldIndex, 1)[0];
                        list.splice(evt.newIndex, 0, item);
                    }
                });
            }
        }

        function updateLoc(i, v) { v = v.trim(); if(appData.itinerary[currentDay][i]) { appData.itinerary[currentDay][i].loc = v; renderSchedule(); } }
        function updateTimeText(i, val) { val = val.trim(); if(appData.itinerary[currentDay][i]) { appData.itinerary[currentDay][i].time = val; renderSchedule(); } }
        function updateItinerary(i, k, v) { if(appData.itinerary[currentDay][i]) appData.itinerary[currentDay][i][k] = v.trim(); }
        function toggleMemo(i) { const item = appData.itinerary[currentDay][i]; item.memo = item.memo ? "" : "å‚™å¿˜..."; renderSchedule(); }
        
        function updateType(index, val) {
            if (val === "ADD_NEW") {
                const newType = prompt("è«‹è¼¸å…¥æ–°æ¨™ç±¤ (ä¾‹å¦‚: ğŸœ æ‹‰éºµ)ï¼š");
                if (newType && newType.trim()) {
                    appData.activityTypes.push(newType.trim());
                    appData.itinerary[currentDay][index].type = newType.trim();
                    saveDataToCloud(true); renderSchedule();
                } else { renderSchedule(); }
            } else if (val === "DEL_OPTION") {
                const target = prompt("è¼¸å…¥è¦åˆªé™¤çš„æ¨™ç±¤åç¨±ï¼š");
                if (target && appData.activityTypes.includes(target)) {
                    if(confirm(`åˆªé™¤ã€Œ${target}ã€ï¼Ÿ`)) {
                        appData.activityTypes = appData.activityTypes.filter(t => t !== target);
                        saveDataToCloud(true); renderSchedule();
                    }
                } else { renderSchedule(); }
            } else { appData.itinerary[currentDay][index].type = val; }
        }

        function renderChecklist() {
            const container = document.getElementById('checklist-container');
            container.innerHTML = '';
            const targetList = currentChecklistType === 'pre' ? appData.checklist_pre : appData.checklist_tour;
            (targetList || []).forEach((cat, ci) => {
                let itemsHtml = '';
                cat.items.forEach((item, ii) => {
                    itemsHtml += `<div class="check-item ${item.checked?'checked':''}"><div class="custom-checkbox" onclick="toggleCheck(${ci},${ii})"><i>âœ”</i></div><div class="item-text" onblur="updCheck(${ci},${ii},this.innerText)">${item.text}</div><div class="del-check-btn" onclick="delCheck(${ci},${ii})">âœ•</div></div>`;
                });
                const div = document.createElement('div');
                div.className = 'checklist-category';
                div.innerHTML = `<div class="cat-title"><span onblur="updCat(${ci},this.innerText)">${cat.category}</span><span class="del-cat-btn" onclick="delCat(${ci})">åˆªé™¤</span></div><div>${itemsHtml}</div><div class="add-check-row"><div class="add-check-btn" onclick="addCheck(${ci})">ï¼‹ æ–°å¢é …ç›®</div></div>`;
                container.appendChild(div);
            });
            setEditable(isEditing);
        }
        function toggleCheck(ci, ii) { if(isEditing) return; const l=getList(); l[ci].items[ii].checked=!l[ci].items[ii].checked; renderChecklist(); saveDataToCloud(true); }
        function updCheck(ci, ii, v) { getList()[ci].items[ii].text = v.trim(); }
        function updCat(ci, v) { getList()[ci].category = v.trim(); }
        function delCheck(ci, ii) { if(confirm('åˆªé™¤ï¼Ÿ')){ getList()[ci].items.splice(ii,1); renderChecklist(); }}
        function addCheck(ci) { getList()[ci].items.push({text:"æ–°é …ç›®", checked:false}); renderChecklist(); }
        function delCat(ci) { if(confirm('åˆªé™¤åˆ†é¡ï¼Ÿ')){ getList().splice(ci,1); renderChecklist(); }}
        function addNewCategory() { getList().push({category:"æ–°åˆ†é¡", items:[]}); renderChecklist(); }
        function getList() { return currentChecklistType === 'pre' ? appData.checklist_pre : appData.checklist_tour; }

        function toggleEditMode() {
            if (!isEditing) {
                const pwd = "8888"; 
                if (!sessionStorage.getItem('isAuth')) {
                    const input = prompt("è«‹è¼¸å…¥ç·¨è¼¯å¯†ç¢¼ï¼š");
                    if (input !== pwd) { alert("å¯†ç¢¼éŒ¯èª¤"); return; }
                    sessionStorage.setItem('isAuth', 'true');
                }
            } else { saveDataToCloud(true); }
            isEditing = !isEditing;
            const btn = document.querySelector('.edit-toggle');
            document.body.classList.toggle('is-editing', isEditing);
            btn.classList.toggle('editing', isEditing);
            
            // æ¨™é¡Œç·¨è¼¯é–‹é—œ
            document.querySelector('.trip-title').contentEditable = isEditing;
            document.querySelector('.trip-subtitle').contentEditable = isEditing;

            setEditable(isEditing);
            renderSchedule(); renderChecklist();
        }
        
        function switchDay(d, b) { currentDay=d; document.querySelectorAll('#tabs-itinerary .tab-btn').forEach(e=>e.classList.remove('active')); b.classList.add('active'); renderSchedule(); }
        function switchChecklistType(t, b) { currentChecklistType=t; document.querySelectorAll('.sub-tab-btn').forEach(e=>e.classList.remove('active')); b.classList.add('active'); renderChecklist(); }
        function setEditable(e) { document.querySelectorAll('.info-title, .info-loc span, .info-note, .memo-box, .item-text, .cat-title span, .time').forEach(f => { f.contentEditable = e; }); }
        function addNewItem() { if(!appData.itinerary[currentDay]) appData.itinerary[currentDay]=[]; appData.itinerary[currentDay].push({id:Date.now(), time:"12:00", type:"âœˆï¸ é£›è¡Œ", title:"æ–°è¡Œç¨‹", loc:"åœ°é»", note:"", memo:""}); renderSchedule(); }
        function deleteItem(i) { if(confirm('åˆªé™¤ï¼Ÿ')){ appData.itinerary[currentDay].splice(i,1); renderSchedule(); }}
        function showStatus(m, e){ const el=document.getElementById('status-indicator'); el.innerText=m; el.classList.add('show'); if(e) el.style.background='red'; else el.style.background='rgba(0,0,0,0.8)'; }
        function hideStatus(){ document.getElementById('status-indicator').classList.remove('show'); }
        document.addEventListener('paste', function (e) { if (e.target.isContentEditable) { e.preventDefault(); const t = (e.clipboardData || window.clipboardData).getData('text'); document.execCommand('insertText', false, t); } });
    </script>
</body>
</html>
