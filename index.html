<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂêçÂè§Â±ã„ÉªÁôΩÂ∑ùÈÑâÂÜ¨ÊóÖ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* --- UI È¢®Ê†ºË®≠ÂÆö --- */
        :root {
            --primary-color: #5856D6;
            --bg-color: #F5F5FA;
            --card-bg: #FFFFFF;
            --danger-color: #FF3B30;
            --success-color: #34C759;
            --text-dark: #1C1C1E;
            --text-gray: #8E8E93;
            --line-color: #E5E5EA;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            padding-top: 180px;
            padding-bottom: 50px;
            -webkit-tap-highlight-color: transparent;
            color: var(--text-dark);
        }

        /* --- Header --- */
        .header {
            background: var(--primary-color);
            padding: 15px 20px 0px 20px;
            border-bottom-left-radius: 24px; border-bottom-right-radius: 24px;
            color: white; box-shadow: 0 4px 20px rgba(88, 86, 214, 0.4);
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
        }
        .header-top-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .trip-title { font-size: 22px; font-weight: 800; letter-spacing: 0.5px; line-height: 1.2; border-bottom: 1px dashed transparent; }
        .trip-subtitle { font-size: 13px; opacity: 0.8; margin-top: 4px; font-weight: 500; border-bottom: 1px dashed transparent; display: inline-block; cursor: pointer;}
        
        .controls { display: flex; gap: 6px; }
        .view-btn { width: 34px; height: 34px; border-radius: 10px; border: none; background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; font-size: 15px; cursor: pointer; transition: 0.2s; }
        .view-btn.active { background: white; color: var(--primary-color); font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .edit-toggle { height: 34px; padding: 0 10px; border-radius: 10px; border: none; background: rgba(0,0,0,0.2); color: white; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .edit-toggle.editing { background: var(--success-color); }

        .tabs-container { padding-bottom: 15px; overflow: hidden; }
        .tabs { display: flex; overflow-x: auto; gap: 10px; scrollbar-width: none; padding: 4px; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab-btn { background: rgba(255,255,255,0.15); border: none; color: rgba(255,255,255,0.8); padding: 8px 0; border-radius: 14px; width: 60px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: white; color: var(--primary-color); font-weight: bold; transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); color: var(--primary-color) !important; }
        .tab-date { font-size: 10px; margin-bottom: 2px; }
        .tab-day { font-size: 16px; font-weight: 800; }
        .sub-tabs { display: none; justify-content: flex-start; gap: 10px; padding: 4px; }
        .sub-tab-btn { background: rgba(0,0,0,0.2); color: rgba(255,255,255,0.8); border: none; padding: 8px 20px; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .sub-tab-btn.active { background: white; color: var(--primary-color); }

        .content { padding: 10px 20px; min-height: 300px; display: none; }
        .content.active { display: block; animation: fadeIn 0.3s; }

        /* Timeline */
        .timeline-item { position: relative; padding-left: 20px; margin-bottom: 20px; }
        .timeline-item::before { content: ''; position: absolute; left: 9px; top: 25px; bottom: -45px; width: 2px; background: var(--line-color); }
        .timeline-item:last-child::before { display: none; }
        .timeline-item::after { content: ''; position: absolute; left: 2px; top: 25px; width: 12px; height: 12px; background: var(--primary-color); border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 2px var(--primary-color); z-index: 2; }
        .card { background: var(--card-bg); border-radius: 20px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02); display: flex; gap: 15px; position: relative; }
        
        .time-col { display: flex; flex-direction: column; align-items: center; min-width: 65px; border-right: 1px dashed #EEE; padding-right: 15px; padding-top: 5px; }
        .ampm { font-size: 11px; color: var(--text-gray); font-weight: 500; }
        .time { font-size: 18px; font-weight: 800; color: var(--text-dark); letter-spacing: -0.5px; }
        .type-badge { margin-top: 6px; padding: 3px 8px; border-radius: 8px; font-size: 10px; font-weight: 600; color: #666; background: #F2F2F7; }
        .type-select { margin-top: 6px; width: 100%; font-size: 11px; display: none; }
        body.is-editing .type-badge { display: none; }
        body.is-editing .type-select { display: block; }

        .info-col { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        .info-title { font-size: 16px; font-weight: 700; color: var(--text-dark); line-height: 1.3; }
        .info-loc { font-size: 12px; color: var(--text-gray); display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        .nav-btn { background: rgba(88, 86, 214, 0.1); color: var(--primary-color); padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; text-decoration: none; display: inline-flex; align-items: center; gap: 2px; cursor: pointer; }
        .info-note { font-size: 13px; color: #FF9500; font-weight: 500; margin-top: 2px; }
        .memo-box { margin-top: 8px; background: #FFF9E6; border-left: 3px solid #FFCC00; padding: 8px; border-radius: 6px; font-size: 12px; color: #665C3B; display: none; white-space: pre-wrap;}
        .memo-box.show { display: block; }

        .drag-handle { position: absolute; left: -25px; top: 50%; transform: translateY(-50%); color: #CCC; font-size: 16px; display: none; cursor: grab; padding: 10px;}
        body.is-editing .drag-handle { display: block; }
        .delete-btn { position: absolute; right: -8px; top: -8px; width: 22px; height: 22px; background: var(--danger-color); color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; z-index: 10; font-size: 12px;}
        body.is-editing .delete-btn { display: flex; }

        /* Checklist */
        .checklist-container { padding: 10px 20px; }
        .checklist-category { background: white; border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .cat-title { font-weight: 700; color: var(--primary-color); border-bottom: 1px solid #EEE; padding-bottom: 8px; margin-bottom: 8px; display:flex; justify-content:space-between;}
        .check-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #FAFAFA; }
        .custom-checkbox { width: 20px; height: 20px; border: 2px solid #DDD; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .check-item.checked .custom-checkbox { background: var(--success-color); border-color: var(--success-color); }
        .check-item.checked .custom-checkbox i { color: white; font-size: 10px; display: block; }
        .custom-checkbox i { display: none; }
        .check-item.checked .item-text { text-decoration: line-through; color: #CCC; }

        /* Expense */
        .expense-summary { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; text-align: center; }
        .total-amount { font-size: 32px; font-weight: 800; color: var(--primary-color); margin: 10px 0; }
        .total-sub { font-size: 13px; color: var(--text-gray); }
        .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 16px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .expense-info { flex: 1; }
        .expense-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
        .expense-price { font-weight: 700; font-size: 16px; color: var(--text-dark); }
        .expense-currency { font-size: 11px; color: #888; background: #EEE; padding: 2px 6px; border-radius: 4px; margin-left: 5px;}
        .expense-input-row { display: flex; gap: 10px; margin-bottom: 20px; }
        .exp-input { flex: 1; padding: 12px; border: 1px solid #DDD; border-radius: 12px; font-size: 14px; }
        .exp-select { padding: 10px; border: 1px solid #DDD; border-radius: 12px; background: white; }
        .rate-setting { font-size: 12px; color: #888; text-align: center; margin-bottom: 10px; cursor: pointer; text-decoration: underline;}

        /* --- V17.0 New Notes Grid Styles --- */
        .notes-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; /* ÂÖ©Ê¨Ñ */
            gap: 15px; 
            padding: 5px; 
            max-height: 60vh; 
            overflow-y: auto;
        }
        .note-card { 
            background: #FFF9C4; /* ‰æøÂà©Ë≤ºÈªÉ */
            border-radius: 12px; 
            padding: 15px; 
            min-height: 120px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            position: relative;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .note-card:active { transform: scale(0.98); }
        .note-preview { font-size: 13px; color: #555; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; line-height: 1.4; white-space: pre-wrap;}
        .note-date { font-size: 10px; color: #999; margin-top: 10px; text-align: right; }
        .note-del-btn {
            position: absolute; top: 5px; right: 5px; width: 20px; height: 20px;
            background: rgba(0,0,0,0.1); border-radius: 50%; color: white;
            display: flex; align-items: center; justify-content: center; font-size: 12px;
            display: none;
        }
        .note-card:hover .note-del-btn { display: flex; }

        /* Modal ÈÄöÁî® */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 400px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); max-height: 85vh; display: flex; flex-direction: column;}
        .modal-title { font-size: 18px; font-weight: 800; margin-bottom: 15px; color: var(--text-dark); display: flex; justify-content: space-between; align-items: center;}
        
        /* Note Editor Modal Specific */
        .note-editor-area { width: 100%; flex: 1; min-height: 300px; border: 1px solid #EEE; border-radius: 10px; padding: 15px; font-size: 15px; line-height: 1.6; resize: none; box-sizing: border-box; font-family: inherit; background: #FFFDF0;}
        .modal-btn { width: 100%; padding: 12px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; margin-top: 15px; background: var(--primary-color); color: white;}
        .close-icon { cursor: pointer; color: #999; font-size: 20px;}

        /* Edit Helpers */
        body.is-editing .info-title, body.is-editing .info-loc span, body.is-editing .info-note, body.is-editing .time { border-bottom: 1px dashed #CCC; background: rgba(0,0,0,0.02); min-width: 20px; }
        .del-check-btn, .del-cat-btn, .add-check-row, .add-cat-btn, .add-btn-container { display: none; }
        body.is-editing .del-check-btn, body.is-editing .del-cat-btn, body.is-editing .add-check-row, body.is-editing .add-cat-btn, body.is-editing .add-btn-container { display: block; }
        .add-btn { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 30px; font-size: 13px; font-weight: 600; box-shadow: 0 4px 10px rgba(88,86,214,0.3); margin-top: 10px; }
        .add-cat-btn { width: 100%; text-align: center; padding: 15px; background: white; border: 2px dashed #DDD; border-radius: 12px; color: #AAA; margin-top: 10px; cursor: pointer;}
        .del-check-btn { color: var(--danger-color); margin-left: auto; cursor: pointer; }
        .add-check-btn { color: var(--link-color); font-size: 13px; padding-top: 5px; cursor: pointer; text-align: center;}

        #status-indicator { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 30px; font-size: 12px; z-index: 2000; display: none; }
        #status-indicator.show { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top-row">
            <div class="title-group">
                <div class="trip-title" contenteditable="false" onblur="updateTitle(this.innerText)">üáØüáµ ÂêçÂè§Â±ã„ÉªÁôΩÂ∑ùÈÑâ</div>
                <div class="trip-subtitle" contenteditable="false" onblur="updateSubtitle(this.innerText)">DEC 05 - DEC 09, 2025</div>
            </div>
            <div class="controls">
                <button id="btn-view-itinerary" class="view-btn active" onclick="switchView('itinerary')"><i class="far fa-calendar-alt"></i></button>
                <button id="btn-view-checklist" class="view-btn" onclick="switchView('checklist')"><i class="fas fa-tasks"></i></button>
                <button id="btn-view-expenses" class="view-btn" onclick="switchView('expenses')"><i class="fas fa-yen-sign"></i></button>
                <button id="btn-open-notes" class="view-btn" onclick="openNotesList()"><i class="fas fa-sticky-note"></i></button>
                <button class="edit-toggle" onclick="toggleEditMode()"><i class="fas fa-pen"></i></button>
            </div>
        </div>
        <div class="tabs-container">
            <div id="tabs-itinerary" class="tabs">
                <button class="tab-btn active" onclick="switchDay('d1', this)"><span class="tab-date">ÈÄ±Âõõ</span><span class="tab-day">D1</span></button>
                <button class="tab-btn" onclick="switchDay('d2', this)"><span class="tab-date">ÈÄ±‰∫î</span><span class="tab-day">D2</span></button>
                <button class="tab-btn" onclick="switchDay('d3', this)"><span class="tab-date">ÈÄ±ÂÖ≠</span><span class="tab-day">D3</span></button>
                <button class="tab-btn" onclick="switchDay('d4', this)"><span class="tab-date">ÈÄ±Êó•</span><span class="tab-day">D4</span></button>
                <button class="tab-btn" onclick="switchDay('d5', this)"><span class="tab-date">ÈÄ±‰∏Ä</span><span class="tab-day">D5</span></button>
                <button class="tab-btn" onclick="switchDay('d6', this)"><span class="tab-date">ÈÄ±‰∫å</span><span class="tab-day">D6</span></button>
            </div>
            <div id="tabs-checklist" class="sub-tabs">
                <button class="sub-tab-btn active" onclick="switchChecklistType('pre', this)">üè† Ë°åÂâçÊ∫ñÂÇô</button>
                <button class="sub-tab-btn" onclick="switchChecklistType('tour', this)">üß≥ ÊóÖÈÅäÊ∏ÖÂñÆ</button>
            </div>
            <div id="tabs-expenses" class="sub-tabs" style="display:none; justify-content:center; color:white; font-size:14px; opacity:0.8;">
                üí∞ ÊóÖÈÅäË®òÂ∏≥Â∞èÂπ´Êâã
            </div>
        </div>
    </div>

    <div id="container-itinerary" class="content active">
        <div id="schedule-container"></div>
        <div class="add-btn-container"><button class="add-btn" onclick="addNewItem()">Ôºã Êñ∞Â¢ûË°åÁ®ã</button></div>
    </div>

    <div id="container-checklist" class="content">
        <div id="checklist-container"></div>
        <div class="add-cat-btn" onclick="addNewCategory()">Ôºã Êñ∞Â¢û‰∏ÄÂÄãÂ§ßÂàÜÈ°û</div>
    </div>

    <div id="container-expenses" class="content">
        <div class="expense-summary">
            <div class="total-sub">Á∏ΩÊîØÂá∫ (ÊäòÂêàÂè∞Âπ£)</div>
            <div class="total-amount" id="total-twd">NT$ 0</div>
            <div class="rate-setting" onclick="updateExchangeRate()">ÁõÆÂâçÂåØÁéá: <span id="current-rate">0.22</span> (ÈªûÊìä‰øÆÊîπ)</div>
        </div>
        <div class="expense-input-row">
            <input type="text" id="exp-name" class="exp-input" placeholder="È†ÖÁõÆ (Â¶Ç: ÊôöÈ§ê)">
            <input type="number" id="exp-amount" class="exp-input" placeholder="ÈáëÈ°ç" style="width:80px;">
            <select id="exp-curr" class="exp-select"><option value="JPY">JPY</option><option value="TWD">TWD</option></select>
            <button class="add-btn" style="margin-top:0;" onclick="addExpense()">Ôºã</button>
        </div>
        <div id="expenses-list"></div>
    </div>

    <div id="notes-list-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">
                <span>üìù Èö®Ë∫´Á≠ÜË®ò</span>
                <span class="close-icon" onclick="closeNotesList()">√ó</span>
            </div>
            <div id="notes-grid-container" class="notes-grid">
                </div>
            <button class="modal-btn" onclick="createNewNote()">Ôºã Êñ∞Â¢ûÁ≠ÜË®ò</button>
        </div>
    </div>

    <div id="note-editor-modal" class="modal-overlay" style="z-index: 3100;">
        <div class="modal-box">
            <div class="modal-title">
                <span>Á∑®ËºØÁ≠ÜË®ò</span>
                <span class="close-icon" onclick="closeNoteEditor()">√ó</span>
            </div>
            <textarea id="current-note-input" class="note-editor-area" placeholder="Ëº∏ÂÖ•ÂÖßÂÆπ..."></textarea>
            <button class="modal-btn" onclick="saveAndCloseNoteEditor()">ÂÑ≤Â≠ò‰∏¶ËøîÂõû</button>
        </div>
    </div>

    <div id="status-indicator"><i class="fas fa-sync fa-spin"></i> ÂêåÊ≠•‰∏≠...</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDTQeG0emT5pqRYwCebkyVyGttmy-t6crY",
            authDomain: "travel-d67d0.firebaseapp.com",
            projectId: "travel-d67d0",
            storageBucket: "travel-d67d0.firebasestorage.app",
            messagingSenderId: "223292356224",
            appId: "1:223292356224:web:5511095a095ffc4080d865"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tripDocRef = db.collection("trips").doc("nagoya_2025_trip_v16_final"); 

        const defaultData = {
            meta: { title: "üáØüáµ ÂêçÂè§Â±ã„ÉªÁôΩÂ∑ùÈÑâ", subtitle: "DEC 05 - DEC 09, 2025", rate: 0.22 },
            notes: null, // Legacy field (deprecated)
            notesList: [], // New: Array of note objects
            expenses: [], 
            itinerary: {
                d1: [{ id: 101, time: "11:00", type: "‚úàÔ∏è È£õË°å", title: "ÊäµÈÅîÊ°ÉÂúíÊ©üÂ†¥", loc: "Ê°ÉÂúíÊ©üÂ†¥Á¨¨‰∏ÄËà™Âªà", note: "Ê∫ñÂÇô Check-in", memo: "" }],
                d2: [], d3: [], d4: [], d5: [], d6: []
            },
            checklist_pre: [{ category: "ÂøÖÂÇôË≠â‰ª∂", items: [{ text: "Ë≠∑ÁÖß", checked: false }] }],
            checklist_tour: [{ category: "ÂøÖË≤∑", items: [{ text: "Ëó•Â¶ù", checked: false }] }],
            activityTypes: ["‚úàÔ∏è È£õË°å", "üöÑ ‰∫§ÈÄö", "üé° ÊôØÈªû", "üç¥ Áî®È§ê", "üè® ‰ΩèÂÆø", "üõçÔ∏è Ë≥ºÁâ©", "üöó ‰∫§ÈÄö", "üè† ËøîÂÆ∂"]
        };

        let currentDay = 'd1';
        let currentChecklistType = 'pre';
        let isEditing = false;
        let appData = JSON.parse(JSON.stringify(defaultData));
        let sortableInstance = null;
        let currentEditingNoteId = null;

        window.onload = function() { initRealtimeSync(); };

        function initRealtimeSync() {
            showStatus("ÈÄ£Á∑ö‰∏≠...");
            tripDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const remoteData = doc.data();
                    if (!isEditing || !appData.itinerary) {
                        appData = remoteData;
                        // Data Migration & Safety Checks
                        if(!appData.expenses) appData.expenses = [];
                        if(!appData.meta.rate) appData.meta.rate = 0.22;
                        
                        // ‚òÖ Á≠ÜË®òË≥áÊñôÈÅ∑ÁßªÈÇèËºØ (ÈáçË¶Å) ‚òÖ
                        if(typeof appData.notes === 'string' && appData.notes.trim() !== "") {
                            if(!appData.notesList) appData.notesList = [];
                            // ÊääËàäÁöÑÂñÆ‰∏ÄÊñáÂ≠óÁ≠ÜË®òÔºåËΩâÊàêÁ¨¨‰∏ÄÂºµÂç°Áâá
                            appData.notesList.push({ id: Date.now(), content: appData.notes, date: new Date().toLocaleDateString() });
                            appData.notes = null; // Ê∏ÖÁ©∫ËàäÊ¨Ñ‰Ωç
                            saveDataToCloud(true); // Á´ãÂç≥Â≠òÊ™îÊõ¥Êñ∞ÁµêÊßã
                        }
                        if(!appData.notesList) appData.notesList = []; // ÂàùÂßãÂåñÈô£Âàó

                        document.querySelector('.trip-title').innerText = appData.meta.title;
                        document.querySelector('.trip-subtitle').innerText = appData.meta.subtitle;
                        document.getElementById('current-rate').innerText = appData.meta.rate;
                        
                        renderSchedule(); renderChecklist(); renderExpenses();
                        // Â¶ÇÊûúÁ≠ÜË®òÂàóË°®ÈñãËëóÔºå‰πüË¶ÅÂà∑Êñ∞
                        if(document.getElementById('notes-list-modal').classList.contains('show')) {
                            renderNotesGrid();
                        }
                    }
                    showStatus("Â∑≤ÂêåÊ≠•", false);
                    setTimeout(() => hideStatus(), 2000);
                } else { saveDataToCloud(true); }
            }, (error) => { console.error(error); showStatus("ÂêåÊ≠•Â§±Êïó"); });
        }

        let saveTimeout;
        function triggerSave() {
            showStatus("ÂÑ≤Â≠ò‰∏≠...");
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => { saveDataToCloud(true); }, 1000);
        }

        function saveDataToCloud(force = false) {
            showStatus("ÂÑ≤Â≠ò‰∏≠...");
            tripDocRef.set(appData)
                .then(() => { showStatus("Â∑≤ÂÑ≤Â≠ò"); setTimeout(() => hideStatus(), 2000); })
                .catch((e) => showStatus("ÂÑ≤Â≠òÂ§±Êïó"));
        }

        function switchView(view) {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-view-' + view).classList.add('active');
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById('container-' + view).classList.add('active');
            
            document.getElementById('tabs-itinerary').style.display = view === 'itinerary' ? 'flex' : 'none';
            document.getElementById('tabs-checklist').style.display = view === 'checklist' ? 'flex' : 'none';
            document.getElementById('tabs-expenses').style.display = view === 'expenses' ? 'flex' : 'none';
        }

        // --- üìù Á≠ÜË®òÊñ∞ÂäüËÉΩ (Grid + Card) ---
        function openNotesList() {
            renderNotesGrid();
            document.getElementById('notes-list-modal').classList.add('show');
        }
        function closeNotesList() {
            document.getElementById('notes-list-modal').classList.remove('show');
        }
        
        function renderNotesGrid() {
            const container = document.getElementById('notes-grid-container');
            container.innerHTML = '';
            
            if(!appData.notesList || appData.notesList.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#999; padding:20px;">Â∞öÁÑ°Á≠ÜË®òÔºåÈªûÊìä‰∏ãÊñπÊñ∞Â¢û</div>';
                return;
            }

            appData.notesList.forEach(note => {
                const div = document.createElement('div');
                div.className = 'note-card';
                div.onclick = function(e) { 
                    // Â¶ÇÊûúÈªûÂà∞Âà™Èô§ÈàïÂ∞±‰∏çÈñãÁ∑®ËºØ
                    if(e.target.closest('.note-del-btn')) return;
                    openNoteEditor(note.id); 
                };
                
                // È†êË¶ΩÊñáÂ≠óËôïÁêÜ
                let preview = note.content || "(Á©∫ÁôΩÁ≠ÜË®ò)";
                
                div.innerHTML = `
                    <div class="note-del-btn" onclick="deleteNote(${note.id})">√ó</div>
                    <div class="note-preview">${preview}</div>
                    <div class="note-date">${note.date || ""}</div>
                `;
                container.appendChild(div);
            });
        }

        function createNewNote() {
            const newId = Date.now();
            appData.notesList.push({
                id: newId,
                content: "",
                date: new Date().toLocaleDateString()
            });
            triggerSave();
            renderNotesGrid();
            openNoteEditor(newId); // Áõ¥Êé•ÊâìÈñãÁ∑®ËºØ
        }

        function openNoteEditor(id) {
            currentEditingNoteId = id;
            const note = appData.notesList.find(n => n.id === id);
            if(note) {
                document.getElementById('current-note-input').value = note.content;
                document.getElementById('note-editor-modal').classList.add('show');
            }
        }

        function saveAndCloseNoteEditor() {
            if(currentEditingNoteId) {
                const content = document.getElementById('current-note-input').value;
                const noteIndex = appData.notesList.findIndex(n => n.id === currentEditingNoteId);
                if(noteIndex > -1) {
                    appData.notesList[noteIndex].content = content;
                    triggerSave();
                }
            }
            document.getElementById('note-editor-modal').classList.remove('show');
            renderNotesGrid(); // Âà∑Êñ∞ÂàóË°®È†êË¶Ω
        }
        
        function closeNoteEditor() {
             // ÈóúÈñâÊôÇ‰πüËá™ÂãïÂ≠ò‰∏Ä‰∏ãÔºåÈÅøÂÖçË™§Ëß∏ÈóúÈñâ‰∏üÂ§±
             saveAndCloseNoteEditor();
        }

        function deleteNote(id) {
            if(confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂºµÁ≠ÜË®òÂóéÔºü")) {
                appData.notesList = appData.notesList.filter(n => n.id !== id);
                triggerSave();
                renderNotesGrid();
            }
        }

        // --- Other Functions (Kept same as V16) ---
        function updateTitle(val) { appData.meta.title = val.trim(); triggerSave(); }
        function updateSubtitle(val) { appData.meta.subtitle = val.trim(); triggerSave(); }
        
        function addExpense() {
            const name = document.getElementById('exp-name').value;
            const amount = parseFloat(document.getElementById('exp-amount').value);
            const curr = document.getElementById('exp-curr').value;
            if(!name || !amount) { alert("Ë´ãËº∏ÂÖ•È†ÖÁõÆÂíåÈáëÈ°ç"); return; }
            appData.expenses.push({ id: Date.now(), item: name, amount: amount, curr: curr });
            document.getElementById('exp-name').value = ''; document.getElementById('exp-amount').value = '';
            renderExpenses(); triggerSave();
        }
        function deleteExpense(id) { if(confirm("Âà™Èô§Ê≠§Á≠ÜÊ∂àË≤ªÔºü")) { appData.expenses = appData.expenses.filter(e => e.id !== id); renderExpenses(); triggerSave(); } }
        function updateExchangeRate() { const r = prompt("ÂåØÁéáÔºö", appData.meta.rate); if(r&&!isNaN(r)){ appData.meta.rate=parseFloat(r); document.getElementById('current-rate').innerText=r; renderExpenses(); triggerSave(); } }
        function renderExpenses() {
            const list = document.getElementById('expenses-list'); list.innerHTML = ''; let total = 0; const r = appData.meta.rate || 0.22;
            appData.expenses.forEach(ex => {
                let eq = ex.curr === 'TWD' ? ex.amount : Math.round(ex.amount * r); total += eq;
                list.innerHTML += `<div class="expense-item"><div class="expense-info"><div class="expense-name">${ex.item} <span class="expense-currency">${ex.curr}</span></div></div><div style="text-align:right;"><div class="expense-price">${ex.curr==='TWD'?'NT$':'¬•'} ${ex.amount}</div><div style="font-size:11px; color:#999;">‚âà NT$ ${eq}</div></div><div style="margin-left:15px; color:#FF3B30; cursor:pointer;" onclick="deleteExpense(${ex.id})">√ó</div></div>`;
            });
            document.getElementById('total-twd').innerText = `NT$ ${total.toLocaleString()}`;
        }

        function getPeriod(t) { if(!t||!t.includes(":"))return""; const h=parseInt(t.split(":")[0]); if(h<5)return"Ê∑±Â§ú"; if(h<11)return"‰∏äÂçà"; if(h<14)return"‰∏≠Âçà"; if(h<18)return"‰∏ãÂçà"; return"Êôö‰∏ä"; }
        function renderTypeOptions(v) { let o=`<option value="">ÈÅ∏ÊìáÈ°ûÂûã</option>`; appData.activityTypes.forEach(t=>{o+=`<option value="${t}" ${t===v?'selected':''}>${t}</option>`}); return o+`<option value="ADD_NEW">‚ûï Êñ∞Â¢û...</option><option value="DEL_OPTION" style="color:red;">‚ûñ Âà™Èô§...</option>`; }
        
        function renderSchedule() {
            const container = document.getElementById('schedule-container'); container.innerHTML = '';
            (appData.itinerary[currentDay]||[]).forEach((item, index) => {
                const div = document.createElement('div'); div.className = 'timeline-item'; div.setAttribute('data-index', index);
                let mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((item.loc||"").replace(/üìç|üöó|üöÑ|‚úàÔ∏è/g,'').trim())}`;
                let hasMemo = (item.memo||"").length>0;
                div.innerHTML = `<div class="drag-handle"><i class="fas fa-bars"></i></div><div class="card"><div class="delete-btn" onclick="deleteItem(${index})"><i class="fas fa-times"></i></div><div class="time-col"><div class="ampm">${getPeriod(item.time)}</div><div class="time" onblur="updateTimeText(${index},this.innerText)">${item.time}</div><div class="type-badge">${item.type||""}</div><select class="type-select" onchange="updateType(${index},this.value)">${renderTypeOptions(item.type||"")}</select></div><div class="info-col"><div class="info-title" onblur="updateItinerary(${index},'title',this.innerText)">${item.title}</div><div class="info-loc"><span onblur="updateLoc(${index},this.innerText)">${item.loc}</span><a href="${mapUrl}" target="_blank" class="nav-btn"><i class="fas fa-location-arrow"></i> Â∞éËà™</a></div><div class="info-note" onblur="updateItinerary(${index},'note',this.innerText)">${item.note}</div><div class="memo-box ${hasMemo?'show':''}" onblur="updateItinerary(${index},'memo',this.innerText)">${item.memo||""}</div><div class="memo-controls" style="display:none;margin-top:5px;font-size:12px;"><span onclick="toggleMemo(${index})" style="color:#007AFF;cursor:pointer;">${hasMemo?'Âà™Èô§ÂÇôÂøò':'Êñ∞Â¢ûÂÇôÂøò'}</span></div></div></div>`;
                if(isEditing) div.querySelector('.memo-controls').style.display = 'block'; container.appendChild(div);
            });
            setEditable(isEditing);
            if(isEditing) { if(sortableInstance) sortableInstance.destroy(); sortableInstance = new Sortable(container, { handle:'.drag-handle', animation:150, onEnd: function(evt){ const list=appData.itinerary[currentDay]; list.splice(evt.newIndex, 0, list.splice(evt.oldIndex, 1)[0]); triggerSave(); } }); }
        }

        function updateLoc(i, v) { if(appData.itinerary[currentDay][i]){ appData.itinerary[currentDay][i].loc=v.trim(); renderSchedule(); triggerSave(); } }
        function updateTimeText(i, v) { if(appData.itinerary[currentDay][i]){ appData.itinerary[currentDay][i].time=v.trim(); renderSchedule(); triggerSave(); } }
        function updateItinerary(i, k, v) { if(appData.itinerary[currentDay][i]){ appData.itinerary[currentDay][i][k]=v.trim(); triggerSave(); } }
        function toggleMemo(i) { const item=appData.itinerary[currentDay][i]; item.memo=item.memo?"":"ÂÇôÂøò..."; renderSchedule(); triggerSave(); }
        function updateType(i, v) { if(v==="ADD_NEW"){ const n=prompt("Êñ∞Ê®ôÁ±§Ôºö"); if(n){appData.activityTypes.push(n); appData.itinerary[currentDay][i].type=n; saveDataToCloud(true); renderSchedule();} else renderSchedule(); } else if(v==="DEL_OPTION"){ const t=prompt("Âà™Èô§Ê®ôÁ±§Ôºö"); if(t&&confirm("Âà™Èô§Ôºü")){appData.activityTypes=appData.activityTypes.filter(x=>x!==t); saveDataToCloud(true); renderSchedule();} else renderSchedule(); } else { appData.itinerary[currentDay][i].type=v; triggerSave(); } }

        function renderChecklist() {
            const container = document.getElementById('checklist-container'); container.innerHTML = '';
            const list = currentChecklistType==='pre'?appData.checklist_pre:appData.checklist_tour;
            (list||[]).forEach((cat, ci) => {
                let html = ''; cat.items.forEach((item, ii) => { html += `<div class="check-item ${item.checked?'checked':''}"><div class="custom-checkbox" onclick="toggleCheck(${ci},${ii})"><i>‚úî</i></div><div class="item-text" onblur="updCheck(${ci},${ii},this.innerText)">${item.text}</div><div class="del-check-btn" onclick="delCheck(${ci},${ii})">‚úï</div></div>`; });
                const div = document.createElement('div'); div.className = 'checklist-category'; div.innerHTML = `<div class="cat-title"><span onblur="updCat(${ci},this.innerText)">${cat.category}</span><span class="del-cat-btn" onclick="delCat(${ci})">Âà™Èô§</span></div><div>${html}</div><div class="add-check-row"><div class="add-check-btn" onclick="addCheck(${ci})">Ôºã Êñ∞Â¢ûÈ†ÖÁõÆ</div></div>`; container.appendChild(div);
            });
            setEditable(isEditing);
        }
        function toggleCheck(ci, ii) { if(isEditing)return; const l=getList(); l[ci].items[ii].checked=!l[ci].items[ii].checked; renderChecklist(); triggerSave(); }
        function updCheck(ci, ii, v) { getList()[ci].items[ii].text=v.trim(); triggerSave(); }
        function updCat(ci, v) { getList()[ci].category=v.trim(); triggerSave(); }
        function delCheck(ci, ii) { if(confirm("Âà™Èô§Ôºü")){ getList()[ci].items.splice(ii,1); renderChecklist(); triggerSave(); }}
        function addCheck(ci) { getList()[ci].items.push({text:"Êñ∞È†ÖÁõÆ", checked:false}); renderChecklist(); triggerSave(); }
        function delCat(ci) { if(confirm("Âà™Èô§ÂàÜÈ°ûÔºü")){ getList().splice(ci,1); renderChecklist(); triggerSave(); }}
        function addNewCategory() { getList().push({category:"Êñ∞ÂàÜÈ°û", items:[]}); renderChecklist(); triggerSave(); }
        function getList() { return currentChecklistType==='pre'?appData.checklist_pre:appData.checklist_tour; }

        function toggleEditMode() {
            if(!isEditing && !sessionStorage.getItem('isAuth')) { const p=prompt("ÂØÜÁ¢ºÔºö"); if(p!=="8888"){alert("ÈåØË™§");return;} sessionStorage.setItem('isAuth','true'); }
            isEditing = !isEditing;
            document.querySelector('.edit-toggle').classList.toggle('editing', isEditing);
            document.querySelector('.trip-title').contentEditable = isEditing;
            document.querySelector('.trip-subtitle').contentEditable = isEditing;
            setEditable(isEditing); renderSchedule(); renderChecklist();
        }
        
        function switchDay(d, b) { currentDay=d; document.querySelectorAll('#tabs-itinerary .tab-btn').forEach(e=>e.classList.remove('active')); b.classList.add('active'); renderSchedule(); }
        function switchChecklistType(t, b) { currentChecklistType=t; document.querySelectorAll('.sub-tab-btn').forEach(e=>e.classList.remove('active')); b.classList.add('active'); renderChecklist(); }
        function setEditable(e) { document.querySelectorAll('.info-title, .info-loc span, .info-note, .memo-box, .item-text, .cat-title span, .time').forEach(f => { f.contentEditable = e; }); }
        function addNewItem() { if(!appData.itinerary[currentDay]) appData.itinerary[currentDay]=[]; appData.itinerary[currentDay].push({id:Date.now(), time:"12:00", type:"‚úàÔ∏è È£õË°å", title:"Êñ∞Ë°åÁ®ã", loc:"Âú∞Èªû", note:"", memo:""}); renderSchedule(); triggerSave(); }
        function deleteItem(i) { if(confirm('Âà™Èô§Ôºü')){ appData.itinerary[currentDay].splice(i,1); renderSchedule(); triggerSave(); }}
        function showStatus(m, e){ const el=document.getElementById('status-indicator'); el.innerText=m; el.classList.add('show'); if(e) el.style.background='red'; else el.style.background='rgba(0,0,0,0.8)'; }
        function hideStatus(){ document.getElementById('status-indicator').classList.remove('show'); }
        document.addEventListener('paste', function (e) { if (e.target.isContentEditable) { e.preventDefault(); const t = (e.clipboardData || window.clipboardData).getData('text'); document.execCommand('insertText', false, t); } });
    </script>
</body>
</html>
