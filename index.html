<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂêçÂè§Â±ã„ÉªÁôΩÂ∑ùÈÑâÂÜ¨ÊóÖ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- Ê®£ÂºèË®≠ÂÆö (Ëàá‰πãÂâçÁõ∏Âêå) --- */
        :root { --primary-color: #5856D6; --bg-color: #F2F2F7; --card-bg: #FFFFFF; --danger-color: #FF3B30; --success-color: #34C759; --link-color: #007AFF; --text-gray: #8E8E93; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; padding-bottom: 90px; -webkit-tap-highlight-color: transparent; -webkit-text-size-adjust: 100%; }
        .header { background: var(--primary-color); color: white; padding: 20px 20px 10px 20px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .trip-title { font-size: 22px; font-weight: 800; }
        .edit-toggle { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .edit-toggle.editing { background: var(--success-color); border-color: transparent; }
        .page-view { display: none; animation: fadeIn 0.3s; }
        .page-view.active { display: block; }
        .tabs { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; scrollbar-width: none; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 12px; min-width: 55px; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
        .tab-btn.active { background: white; color: var(--primary-color); font-weight: bold; }
        .tab-date { font-size: 10px; margin-bottom: 2px; }
        .tab-day { font-size: 16px; }
        .content { padding: 20px; min-height: 300px; }
        .timeline-item { position: relative; padding-left: 30px; margin-bottom: 20px; }
        .timeline-item::before { content: ''; position: absolute; left: 7px; top: 15px; bottom: -25px; width: 2px; background: #D1D1D6; }
        .timeline-item:last-child::before { display: none; }
        .timeline-item::after { content: ''; position: absolute; left: 0; top: 15px; width: 16px; height: 16px; background: var(--primary-color); border-radius: 50%; border: 3px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card { background: var(--card-bg); border-radius: 16px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 10px; position: relative; }
        .card-main { display: flex; align-items: flex-start; gap: 15px; width: 100%; }
        .time-box { text-align: center; min-width: 50px; }
        .time-box .ampm { font-size: 10px; color: #8E8E93; }
        .time-box .time { font-size: 16px; font-weight: 700; color: #333; }
        .info-box { flex: 1; min-width: 0; }
        .info-title { font-size: 16px; font-weight: 600; color: #000; margin-bottom: 4px; line-height: 1.4; }
        .loc-wrapper { display: flex; align-items: center; gap: 8px; flex-wrap: wrap;}
        .info-loc { font-size: 12px; color: #8E8E93; display: flex; align-items: center; gap: 4px; }
        .map-link { display: inline-flex; align-items: center; gap: 3px; background: rgba(0, 122, 255, 0.1); color: var(--link-color); padding: 2px 8px; border-radius: 6px; font-size: 11px; text-decoration: none; font-weight: 600; white-space: nowrap; }
        .info-note { font-size: 12px; color: #FF9500; margin-top: 4px; line-height: 1.3; }
        .memo-section { width: 100%; background: #FFF9E6; padding: 10px; border-radius: 8px; border-left: 3px solid #FFCC00; font-size: 13px; color: #555; line-height: 1.5; display: none; margin-top: 5px; white-space: pre-wrap; }
        .memo-section.show { display: block; }
        .memo-controls { display: none; gap: 10px; margin-top: 5px; font-size: 12px; }
        .add-memo-btn { color: var(--link-color); cursor: pointer; border: 1px dashed var(--link-color); padding: 4px 8px; border-radius: 4px; display: inline-block;}
        .del-memo-btn { color: var(--danger-color); cursor: pointer; display: inline-block; margin-left: auto;}
        body.is-editing .memo-controls { display: flex; }
        body.is-editing .memo-section { display: block !important; min-height: 40px; border: 1px dashed #ccc; background: #fff;}
        .checklist-container { padding: 20px; }
        .checklist-category { margin-bottom: 25px; background: white; border-radius: 16px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .cat-title { font-size: 18px; font-weight: 700; color: var(--primary-color); margin-bottom: 10px; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center;}
        .check-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid #f9f9f9; }
        .check-item:last-child { border-bottom: none; }
        .custom-checkbox { width: 22px; height: 22px; border: 2px solid #ddd; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
        .custom-checkbox i { color: white; font-size: 12px; display: none; }
        .check-item.checked .custom-checkbox { background: var(--success-color); border-color: var(--success-color); }
        .check-item.checked .custom-checkbox i { display: block; }
        .check-item.checked .item-text { text-decoration: line-through; color: #ccc; }
        .item-text { flex: 1; font-size: 15px; }
        .del-check-btn { color: var(--danger-color); font-size: 14px; padding: 5px; display: none; }
        .add-check-row { display: none; text-align: center; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; }
        .add-check-btn { color: var(--link-color); font-size: 14px; cursor: pointer; }
        body.is-editing .del-check-btn { display: block; }
        body.is-editing .add-check-row { display: block; }
        body.is-editing .item-text { border-bottom: 1px dashed #ccc; background: rgba(0,0,0,0.02); padding: 2px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-top: 1px solid #e0e0e0; display: flex; justify-content: space-around; align-items: center; z-index: 900; }
        .nav-item { flex: 1; text-align: center; color: var(--text-gray); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; }
        .nav-item i { font-size: 20px; }
        .nav-item span { font-size: 10px; font-weight: 500; }
        .nav-item.active { color: var(--primary-color); }
        body.is-editing .time, body.is-editing .info-title, body.is-editing .info-loc, body.is-editing .info-note, body.is-editing .ampm, body.is-editing .cat-title span { border-bottom: 1px dashed #ccc; background: rgba(0,0,0,0.02) !important; padding: 2px; }
        body.is-editing .map-link { display: none; }
        .delete-btn { position: absolute; right: -10px; top: -10px; background: var(--danger-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: none; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }
        body.is-editing .delete-btn { display: flex; }
        .add-btn-container { text-align: center; margin-top: 20px; display: none; }
        body.is-editing .add-btn-container { display: block; }
        .add-btn { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 20px; font-size: 14px; box-shadow: 0 4px 10px rgba(88, 86, 214, 0.3); }
        
        /* ÁãÄÊÖãÊåáÁ§∫Ááà */
        #status-indicator { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 30px; font-size: 12px; transition: 0.3s; z-index: 1000; display: none; align-items: center; gap: 5px; }
        #status-indicator.show { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top">
            <div class="trip-title" contenteditable="false">üáØüáµ ÂêçÂè§Â±ã„ÉªÁôΩÂ∑ùÈÑâ</div>
            <button class="edit-toggle" onclick="toggleEditMode()">
                <i class="fas fa-pen"></i> <span id="editBtnText">Á∑®ËºØ</span>
            </button>
        </div>
        <div id="itinerary-tabs" class="tabs">
            <button class="tab-btn active" onclick="switchDay('d1', this)"><span class="tab-date">ÈÄ±Âõõ</span><span class="tab-day">D1</span></button>
            <button class="tab-btn" onclick="switchDay('d2', this)"><span class="tab-date">ÈÄ±‰∫î</span><span class="tab-day">D2</span></button>
            <button class="tab-btn" onclick="switchDay('d3', this)"><span class="tab-date">ÈÄ±ÂÖ≠</span><span class="tab-day">D3</span></button>
            <button class="tab-btn" onclick="switchDay('d4', this)"><span class="tab-date">ÈÄ±Êó•</span><span class="tab-day">D4</span></button>
            <button class="tab-btn" onclick="switchDay('d5', this)"><span class="tab-date">ÈÄ±‰∏Ä</span><span class="tab-day">D5</span></button>
            <button class="tab-btn" onclick="switchDay('d6', this)"><span class="tab-date">ÈÄ±‰∫å</span><span class="tab-day">D6</span></button>
        </div>
        <div id="checklist-header" style="display:none; color:white; font-size:14px; opacity:0.9;">Âá∫ÁôºÂâçË®òÂæóÊ™¢Êü•Ë°åÊùéÂñîÔºÅüéí</div>
    </div>

    <div id="view-itinerary" class="page-view active">
        <div class="content" id="schedule-container"></div>
        <div class="add-btn-container"><button class="add-btn" onclick="addNewItem()"><i class="fas fa-plus"></i> Êñ∞Â¢ûË°åÁ®ã</button></div>
    </div>

    <div id="view-checklist" class="page-view">
        <div class="checklist-container" id="checklist-container"></div>
    </div>

    <div id="status-indicator"><i class="fas fa-sync fa-spin"></i> ÂêåÊ≠•‰∏≠...</div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('itinerary', this)"><i class="fas fa-map-marked-alt"></i><span>Ë°åÁ®ã</span></div>
        <div class="nav-item" onclick="switchPage('checklist', this)"><i class="fas fa-clipboard-check"></i><span>Ê∏ÖÂñÆ</span></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // --- V8 ÁµÇÊ•µÂêà‰ΩµÁâàË®≠ÂÆö ---
        const firebaseConfig = {
            apiKey: "AIzaSyDTQeG0emT5pqRYwCebkyVyGttmy-t6crY",
            authDomain: "travel-d67d0.firebaseapp.com",
            projectId: "travel-d67d0",
            storageBucket: "travel-d67d0.firebasestorage.app",
            messagingSenderId: "223292356224",
            appId: "1:223292356224:web:5511095a095ffc4080d865"
        };

        // ÂàùÂßãÂåñ Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const tripDocRef = db.collection("trips").doc("nagoya_2025_trip"); 

        const defaultData = {
            itinerary: {
                d1: [
                    { id: 101, ampm: "‰∏äÂçà", time: "11:00", title: "ÊäµÈÅîÊ°ÉÂúíÊ©üÂ†¥", loc: "Ê°ÉÂúíÊ©üÂ†¥ T1", note: "Ê∫ñÂÇô Check-in", memo: "" },
                    { id: 103, ampm: "Êôö‰∏ä", time: "20:00", title: "È£ØÂ∫ó Check-in", loc: "BASE LAYER Hotel", note: "ÊîæË°åÊùé", memo: "" }
                ],
                d2: [], d3: [], d4: [], d5: [], d6: []
            },
            checklist: [
                { category: "ÂøÖÂÇôË≠â‰ª∂", items: [{ text: "Ë≠∑ÁÖß", checked: false }, { text: "Êó•Âπ£", checked: false }] },
                { category: "ÈõªÂ≠êÁî¢ÂìÅ", items: [{ text: "ÊâãÊ©ü", checked: false }, { text: "Á∂≤Âç°", checked: false }] }
            ]
        };

        let currentDay = 'd1';
        let isEditing = false;
        let appData = JSON.parse(JSON.stringify(defaultData));

        window.onload = function() {
            initRealtimeSync(); 
        };

        // --- Ê†∏ÂøÉÔºöÂç≥ÊôÇÂêåÊ≠• ---
        function initRealtimeSync() {
            showStatus("ÈÄ£Á∑ö‰∏≠...", true);
            tripDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const remoteData = doc.data();
                    appData = remoteData;
                    if(!document.activeElement.isContentEditable) {
                        renderSchedule();
                        renderChecklist();
                    }
                    showStatus("Â∑≤ÂêåÊ≠•ÊúÄÊñ∞Ë≥áÊñô", false);
                    setTimeout(() => hideStatus(), 2000);
                } else {
                    saveDataToCloud(); 
                }
            }, (error) => {
                console.error("ÂêåÊ≠•Â§±Êïó:", error);
                // Â¶ÇÊûúÊÇ®ÁúãÂà∞ÈÄôÂÄãÈåØË™§Ôºå‰ª£Ë°® Firebase Ë≥áÊñôÂ∫´Ê≤íÈñãÈÄöÔºÅ
                if(error.code === 'permission-denied' || error.code === 'not-found' || error.message.includes('not enabled')) {
                    showStatus("ÈåØË™§ÔºöË´ãÂà∞ Firebase Console Âª∫Á´ãË≥áÊñôÂ∫´ÔºÅ", true);
                } else {
                    showStatus("ÈÄ£Á∑öÂ§±Êïó (Ë´ãÊ™¢Êü•Á∂≤Ë∑Ø)", true);
                }
            });
        }

        let saveTimeout;
        function triggerSave() {
            showStatus("ÂÑ≤Â≠ò‰∏≠...", true);
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveDataToCloud, 1000);
        }

        function saveDataToCloud() {
            tripDocRef.set(appData)
                .then(() => {
                    showStatus("Â∑≤ÂÑ≤Â≠òËá≥Èõ≤Á´Ø", false);
                    setTimeout(() => hideStatus(), 2000);
                })
                .catch((error) => {
                    console.error("ÂÑ≤Â≠òÂ§±Êïó: ", error);
                    showStatus("ÂÑ≤Â≠òÂ§±Êïó", true);
                });
        }

        // --- ‰ªãÈù¢Ê∏≤Êüì ---
        function renderSchedule() {
            const container = document.getElementById('schedule-container');
            container.innerHTML = '';
            if (!appData.itinerary) appData.itinerary = {};
            const dayList = appData.itinerary[currentDay] || [];

            dayList.forEach((item, index) => {
                let cleanLoc = item.loc ? item.loc.replace(/üìç|üöó|üöÑ|‚úàÔ∏è/g, '').trim() : "";
                let mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(cleanLoc)}`;
                let memoContent = item.memo || "";
                let hasMemo = memoContent.length > 0;
                let memoDisplayClass = hasMemo ? "show" : "";

                const div = document.createElement('div');
                div.className = 'timeline-item';
                div.innerHTML = `
                    <div class="card">
                        <div class="delete-btn" onclick="deleteItem(${index})"><i class="fas fa-times"></i></div>
                        <div class="card-main">
                            <div class="time-box">
                                <div class="ampm" onblur="updateItinerary(${index}, 'ampm', this.innerText)">${item.ampm}</div>
                                <div class="time" onblur="updateItinerary(${index}, 'time', this.innerText)">${item.time}</div>
                            </div>
                            <div class="info-box">
                                <div class="info-title" onblur="updateItinerary(${index}, 'title', this.innerText)">${item.title}</div>
                                <div class="loc-wrapper">
                                    <div class="info-loc" onblur="updateItinerary(${index}, 'loc', this.innerText)">${item.loc}</div>
                                    <a href="${mapUrl}" target="_blank" class="map-link"><i class="fas fa-location-arrow"></i> Â∞éËà™</a>
                                </div>
                                <div class="info-note" onblur="updateItinerary(${index}, 'note', this.innerText)">${item.note}</div>
                            </div>
                        </div>
                        <div class="memo-wrapper">
                            <div class="memo-controls">
                                ${!hasMemo ? `<div class="add-memo-btn" onclick="toggleMemo(${index}, true)">+ Êñ∞Â¢ûÂÇôÂøòÈåÑ</div>` : ''}
                                ${hasMemo ? `<div class="del-memo-btn" onclick="toggleMemo(${index}, false)"><i class="fas fa-trash"></i> Âà™Èô§ÂÇôÂøò</div>` : ''}
                            </div>
                            <div class="memo-section ${memoDisplayClass}" onblur="updateItinerary(${index}, 'memo', this.innerText)">${memoContent}</div>
                        </div>
                    </div>`;
                container.appendChild(div);
            });
            setEditable(isEditing);
        }

        function updateItinerary(index, key, value) {
            if (!appData.itinerary[currentDay][index]) return;
            appData.itinerary[currentDay][index][key] = value.trim();
            triggerSave();
        }
        
        function toggleMemo(index, show) {
            if (!appData.itinerary[currentDay][index]) return;
            appData.itinerary[currentDay][index].memo = show ? "Ë´ãËº∏ÂÖ•..." : "";
            renderSchedule(); triggerSave();
        }

        function renderChecklist() {
            const container = document.getElementById('checklist-container');
            container.innerHTML = '';
            (appData.checklist || []).forEach((cat, catIndex) => {
                const catDiv = document.createElement('div');
                catDiv.className = 'checklist-category';
                let itemsHtml = '';
                cat.items.forEach((item, itemIndex) => {
                    itemsHtml += `
                        <div class="check-item ${item.checked ? 'checked' : ''}">
                            <div class="custom-checkbox" onclick="toggleCheck(${catIndex}, ${itemIndex})"><i class="fas fa-check"></i></div>
                            <div class="item-text" onblur="updateCheckItem(${catIndex}, ${itemIndex}, this.innerText)">${item.text}</div>
                            <div class="del-check-btn" onclick="deleteCheckItem(${catIndex}, ${itemIndex})"><i class="fas fa-minus-circle"></i></div>
                        </div>`;
                });
                catDiv.innerHTML = `<div class="cat-title"><span onblur="updateCatTitle(${catIndex}, this.innerText)">${cat.category}</span></div><div class="cat-items">${itemsHtml}</div><div class="add-check-row"><div class="add-check-btn" onclick="addCheckItem(${catIndex})">+ Êñ∞Â¢ûÈ†ÖÁõÆ</div></div>`;
                container.appendChild(catDiv);
            });
            setEditable(isEditing);
        }

        function toggleCheck(catIndex, itemIndex) {
            if(isEditing) return;
            appData.checklist[catIndex].items[itemIndex].checked = !appData.checklist[catIndex].items[itemIndex].checked;
            renderChecklist(); triggerSave();
        }
        function updateCheckItem(c, i, v) { appData.checklist[c].items[i].text = v.trim(); triggerSave(); }
        function updateCatTitle(c, v) { appData.checklist[c].category = v.trim(); triggerSave(); }
        function addCheckItem(c) { appData.checklist[c].items.push({ text: "Êñ∞È†ÖÁõÆ", checked: false }); renderChecklist(); triggerSave(); }
        function deleteCheckItem(c, i) { if(confirm('Âà™Èô§Ôºü')) { appData.checklist[c].items.splice(i, 1); renderChecklist(); triggerSave(); } }

        function switchDay(dayId, btn) { currentDay = dayId; document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); btn.classList.add('active'); renderSchedule(); }
        function switchPage(pageName, navBtn) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); navBtn.classList.add('active');
            document.querySelectorAll('.page-view').forEach(el => el.classList.remove('active')); document.getElementById('view-' + pageName).classList.add('active');
            if(pageName === 'itinerary') { document.getElementById('itinerary-tabs').style.display = 'flex'; document.getElementById('checklist-header').style.display = 'none'; }
            else { document.getElementById('itinerary-tabs').style.display = 'none'; document.getElementById('checklist-header').style.display = 'block'; }
        }
        
        // --- ÂØÜÁ¢ºËàáÁ∑®ËºØÂàáÊèõ ---
        function toggleEditMode() {
            if (!isEditing) {
                // ‚òÖ ÂØÜÁ¢ºË®≠ÂÆöËôï ‚òÖ
                const myPassword = "8888"; 
                if (!sessionStorage.getItem('isAuth')) {
                    const input = prompt("Ë´ãËº∏ÂÖ•Á∑®ËºØÂØÜÁ¢ºÔºö");
                    if (input === null || input !== myPassword) {
                        alert("ÂØÜÁ¢ºÈåØË™§ÔºÅüôÖ‚Äç‚ôÇÔ∏è");
                        return; 
                    }
                    sessionStorage.setItem('isAuth', 'true');
                }
            }
            isEditing = !isEditing;
            const btnText = document.getElementById('editBtnText');
            const toggleBtn = document.querySelector('.edit-toggle');
            document.body.classList.toggle('is-editing', isEditing);
            toggleBtn.classList.toggle('editing', isEditing);
            btnText.innerText = isEditing ? 'ÂÆåÊàê' : 'Á∑®ËºØ';
            setEditable(isEditing);
            renderSchedule(); renderChecklist();
        }
        
        function setEditable(editable) { document.querySelectorAll('.time, .info-title, .info-loc, .info-note, .ampm, .memo-section, .item-text, .cat-title span').forEach(field => { field.contentEditable = editable; }); }
        function addNewItem() { if (!appData.itinerary[currentDay]) appData.itinerary[currentDay] = []; appData.itinerary[currentDay].push({ id: Date.now(), ampm: "ÊôÇÊÆµ", time: "00:00", title: "Êñ∞Ë°åÁ®ã", loc: "Âú∞Èªû", note: "ÂÇôË®ª", memo: "" }); renderSchedule(); triggerSave(); }
        function deleteItem(index) { if(confirm('Âà™Èô§Ôºü')) { appData.itinerary[currentDay].splice(index, 1); renderSchedule(); triggerSave(); } }
        
        function showStatus(msg, isError) {
            const el = document.getElementById('status-indicator');
            el.innerHTML = isError ? `<i class="fas fa-exclamation-circle"></i> ${msg}` : `<i class="fas fa-check"></i> ${msg}`;
            el.style.background = isError ? 'rgba(255, 59, 48, 0.9)' : 'rgba(0,0,0,0.8)';
            el.classList.add('show');
        }
        function hideStatus() { document.getElementById('status-indicator').classList.remove('show'); }
        document.addEventListener('paste', function (e) { if (e.target.isContentEditable) { e.preventDefault(); const text = (e.clipboardData || window.clipboardData).getData('text'); document.execCommand('insertText', false, text); } });
    </script>
</body>
</html>
