<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åå¤å±‹ãƒ»ç™½å·é„‰å†¬æ—…</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        /* --- æ¨£å¼è¨­å®š --- */
        :root { --primary-color: #5856D6; --bg-color: #F2F2F7; --card-bg: #FFFFFF; --danger-color: #FF3B30; --success-color: #34C759; --link-color: #007AFF; --text-gray: #8E8E93; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; padding-bottom: 90px; -webkit-tap-highlight-color: transparent; -webkit-text-size-adjust: 100%; }
        
        .header { background: var(--primary-color); color: white; padding: 20px 20px 10px 20px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .trip-title { font-size: 22px; font-weight: 800; }
        .edit-toggle { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .edit-toggle.editing { background: var(--success-color); border-color: transparent; }
        
        .page-view { display: none; animation: fadeIn 0.3s; }
        .page-view.active { display: block; }
        
        /* Tabs */
        .tabs { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; scrollbar-width: none; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 12px; min-width: 55px; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
        .tab-btn.active { background: white; color: var(--primary-color); font-weight: bold; }
        .tab-date { font-size: 10px; margin-bottom: 2px; }
        .tab-day { font-size: 16px; }

        .sub-tabs { display: flex; justify-content: center; gap: 10px; margin-top: 10px; padding-bottom: 5px; }
        .sub-tab-btn { background: rgba(0,0,0,0.1); color: rgba(255,255,255,0.8); border: none; padding: 6px 15px; border-radius: 20px; font-size: 13px; cursor: pointer; }
        .sub-tab-btn.active { background: white; color: var(--primary-color); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* è¡Œç¨‹å¡ç‰‡ */
        .content { padding: 20px; min-height: 300px; }
        .timeline-item { position: relative; padding-left: 10px; margin-bottom: 20px; transition: transform 0.2s; } /* padding-left èª¿æ•´é…åˆæ‹–æ›³æŠŠæ‰‹ */
        
        /* å·¦å´æ™‚é–“è»¸ç·š (èª¿æ•´ä½ç½®) */
        .timeline-item::before { content: ''; position: absolute; left: 24px; top: 15px; bottom: -25px; width: 2px; background: #D1D1D6; }
        .timeline-item:last-child::before { display: none; }
        .timeline-item::after { content: ''; position: absolute; left: 17px; top: 15px; width: 16px; height: 16px; background: var(--primary-color); border-radius: 50%; border: 3px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 2; }
        
        .card { background: var(--card-bg); border-radius: 16px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 10px; position: relative; margin-left: 20px; }
        .card-main { display: flex; align-items: flex-start; gap: 15px; width: 100%; }

        /* æ–°ï¼šæ‹–æ›³æ‰‹æŠŠ */
        .drag-handle {
            position: absolute; left: -35px; top: 50%; transform: translateY(-50%);
            color: #ccc; font-size: 18px; padding: 10px; cursor: grab;
            display: none; /* é è¨­éš±è— */
        }
        body.is-editing .drag-handle { display: block; }
        
        /* æ–°ï¼šæ™‚é–“è¼¸å…¥æ¡† */
        .time-box { text-align: center; min-width: 55px; display: flex; flex-direction: column; justify-content: center; }
        .time-input {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 18px; font-weight: 700; color: #333;
            border: none; background: transparent;
            text-align: center; width: 100%; padding: 0; margin: 0;
            cursor: pointer;
        }
        /* ç€è¦½æ¨¡å¼ä¸‹ï¼Œè®“æ™‚é–“çœ‹èµ·ä¾†åƒç´”æ–‡å­—ï¼Œä¸å¯é»æ“Š */
        body:not(.is-editing) .time-input { pointer-events: none; }
        /* ç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œçµ¦æ™‚é–“ä¸€å€‹æç¤ºåº•è‰² */
        body.is-editing .time-input { background: rgba(0,0,0,0.05); border-radius: 6px; }

        .info-box { flex: 1; min-width: 0; }
        .info-title { font-size: 16px; font-weight: 600; color: #000; margin-bottom: 4px; line-height: 1.4; }
        .loc-wrapper { display: flex; align-items: center; gap: 8px; flex-wrap: wrap;}
        .info-loc { font-size: 12px; color: #8E8E93; display: flex; align-items: center; gap: 4px; }
        .map-link { display: inline-flex; align-items: center; gap: 3px; background: rgba(0, 122, 255, 0.1); color: var(--link-color); padding: 2px 8px; border-radius: 6px; font-size: 11px; text-decoration: none; font-weight: 600; white-space: nowrap; }
        .info-note { font-size: 12px; color: #FF9500; margin-top: 4px; line-height: 1.3; }
        
        .memo-section { width: 100%; background: #FFF9E6; padding: 10px; border-radius: 8px; border-left: 3px solid #FFCC00; font-size: 13px; color: #555; line-height: 1.5; display: none; margin-top: 5px; white-space: pre-wrap; }
        .memo-section.show { display: block; }
        .memo-controls { display: none; gap: 10px; margin-top: 5px; font-size: 12px; }
        .add-memo-btn { color: var(--link-color); cursor: pointer; border: 1px dashed var(--link-color); padding: 4px 8px; border-radius: 4px; display: inline-block;}
        .del-memo-btn { color: var(--danger-color); cursor: pointer; display: inline-block; margin-left: auto;}
        
        /* æ¸…å–®æ¨£å¼ */
        .checklist-container { padding: 20px; }
        .checklist-category { margin-bottom: 25px; background: white; border-radius: 16px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; }
        .cat-title { font-size: 18px; font-weight: 700; color: var(--primary-color); margin-bottom: 10px; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center;}
        .check-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid #f9f9f9; }
        .check-item:last-child { border-bottom: none; }
        .custom-checkbox { width: 22px; height: 22px; border: 2px solid #ddd; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
        .custom-checkbox i { color: white; font-size: 12px; display: none; }
        .check-item.checked .custom-checkbox { background: var(--success-color); border-color: var(--success-color); }
        .check-item.checked .custom-checkbox i { display: block; }
        .check-item.checked .item-text { text-decoration: line-through; color: #ccc; }
        .item-text { flex: 1; font-size: 15px; }
        
        /* ç·¨è¼¯åŠŸèƒ½é¡¯ç¤º */
        body.is-editing .memo-controls, 
        body.is-editing .del-check-btn, 
        body.is-editing .add-check-row, 
        body.is-editing .del-cat-btn,
        body.is-editing .add-cat-btn { display: block; }
        body.is-editing .memo-section { display: block !important; min-height: 40px; border: 1px dashed #ccc; background: #fff;}
        body.is-editing .add-cat-btn { display: block; }
        
        .del-check-btn { color: var(--danger-color); font-size: 14px; padding: 5px; display: none; }
        .add-check-row { display: none; text-align: center; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; }
        .add-check-btn { color: var(--link-color); font-size: 14px; cursor: pointer; }
        .del-cat-btn { position: absolute; right: 10px; top: 10px; color: #ccc; font-size: 12px; display: none; cursor: pointer; }
        .add-cat-btn { display: none; width: 100%; padding: 12px; background: white; border: 2px dashed #ccc; color: #888; border-radius: 12px; text-align: center; margin-top: 20px; cursor: pointer; }

        /* å°èˆªåˆ— */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-top: 1px solid #e0e0e0; display: flex; justify-content: space-around; align-items: center; z-index: 900; }
        .nav-item { flex: 1; text-align: center; color: var(--text-gray); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; }
        .nav-item i { font-size: 20px; }
        .nav-item span { font-size: 10px; font-weight: 500; }
        .nav-item.active { color: var(--primary-color); }
        
        /* ç·¨è¼¯æ¨¡å¼é€šç”¨ */
        body.is-editing .info-title, body.is-editing .info-loc, body.is-editing .info-note, body.is-editing .cat-title span { border-bottom: 1px dashed #ccc; background: rgba(0,0,0,0.02) !important; padding: 2px; }
        body.is-editing .map-link { display: none; }
        .delete-btn { position: absolute; right: -10px; top: -10px; background: var(--danger-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: none; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }
        body.is-editing .delete-btn { display: flex; }
        .add-btn-container { text-align: center; margin-top: 20px; display: none; }
        body.is-editing .add-btn-container { display: block; }
        .add-btn { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 20px; font-size: 14px; box-shadow: 0 4px 10px rgba(88, 86, 214, 0.3); }
        
        #status-indicator { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 30px; font-size: 12px; transition: 0.3s; z-index: 1000; display: none; align-items: center; gap: 5px; }
        #status-indicator.show { display: flex; }
        
        /* æ‹–æ›³æ™‚çš„æ¨£å¼ */
        .sortable-ghost { opacity: 0.4; background: #eee; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top">
            <div class="trip-title" contenteditable="false">ğŸ‡¯ğŸ‡µ åå¤å±‹ãƒ»ç™½å·é„‰</div>
            <button class="edit-toggle" onclick="toggleEditMode()">
                <i class="fas fa-pen"></i> <span id="editBtnText">ç·¨è¼¯</span>
            </button>
        </div>
        
        <div id="itinerary-tabs" class="tabs">
            <button class="tab-btn active" onclick="switchDay('d1', this)"><span class="tab-date">é€±å››</span><span class="tab-day">D1</span></button>
            <button class="tab-btn" onclick="switchDay('d2', this)"><span class="tab-date">é€±äº”</span><span class="tab-day">D2</span></button>
            <button class="tab-btn" onclick="switchDay('d3', this)"><span class="tab-date">é€±å…­</span><span class="tab-day">D3</span></button>
            <button class="tab-btn" onclick="switchDay('d4', this)"><span class="tab-date">é€±æ—¥</span><span class="tab-day">D4</span></button>
            <button class="tab-btn" onclick="switchDay('d5', this)"><span class="tab-date">é€±ä¸€</span><span class="tab-day">D5</span></button>
            <button class="tab-btn" onclick="switchDay('d6', this)"><span class="tab-date">é€±äºŒ</span><span class="tab-day">D6</span></button>
        </div>
        
        <div id="checklist-tabs" class="sub-tabs" style="display:none;">
            <button class="sub-tab-btn active" onclick="switchChecklistType('pre', this)">ğŸ  è¡Œå‰æº–å‚™</button>
            <button class="sub-tab-btn" onclick="switchChecklistType('tour', this)">ğŸ§³ æ—…éŠæ¸…å–®</button>
        </div>
    </div>

    <div id="view-itinerary" class="page-view active">
        <div class="content" id="schedule-container"></div>
        <div class="add-btn-container"><button class="add-btn" onclick="addNewItem()"><i class="fas fa-plus"></i> æ–°å¢è¡Œç¨‹</button></div>
    </div>

    <div id="view-checklist" class="page-view">
        <div class="checklist-container" id="checklist-container"></div>
        <div class="checklist-container">
            <div class="add-cat-btn" onclick="addNewCategory()">+ æ–°å¢ä¸€å€‹å¤§åˆ†é¡</div>
        </div>
    </div>

    <div id="status-indicator"><i class="fas fa-sync fa-spin"></i> åŒæ­¥ä¸­...</div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('itinerary', this)"><i class="fas fa-map-marked-alt"></i><span>è¡Œç¨‹</span></div>
        <div class="nav-item" onclick="switchPage('checklist', this)"><i class="fas fa-clipboard-check"></i><span>æ¸…å–®</span></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDTQeG0emT5pqRYwCebkyVyGttmy-t6crY",
            authDomain: "travel-d67d0.firebaseapp.com",
            projectId: "travel-d67d0",
            storageBucket: "travel-d67d0.firebasestorage.app",
            messagingSenderId: "223292356224",
            appId: "1:223292356224:web:5511095a095ffc4080d865"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tripDocRef = db.collection("trips").doc("nagoya_2025_trip_v10"); 

        const defaultData = {
            itinerary: {
                d1: [{ id: 101, time: "11:00", title: "æŠµé”æ¡ƒåœ’æ©Ÿå ´", loc: "æ©Ÿå ´", note: "", memo: "" }],
                d2: [], d3: [], d4: [], d5: [], d6: []
            },
            checklist_pre: [{ category: "å¿…å‚™è­‰ä»¶", items: [{ text: "è­·ç…§", checked: false }] }],
            checklist_tour: [{ category: "å¿…è²·", items: [{ text: "è—¥å¦", checked: false }] }]
        };

        let currentDay = 'd1';
        let currentChecklistType = 'pre';
        let isEditing = false;
        let appData = JSON.parse(JSON.stringify(defaultData));
        let sortableInstance = null; // æ‹–æ›³å¯¦ä¾‹

        window.onload = function() { initRealtimeSync(); };

        function initRealtimeSync() {
            showStatus("é€£ç·šä¸­...", true);
            tripDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const remoteData = doc.data();
                    if (!isEditing || !appData.itinerary) {
                        appData = remoteData;
                        // ç›¸å®¹æ€§æª¢æŸ¥ï¼šå¦‚æœèˆŠè³‡æ–™æœ‰ ampmï¼Œé€™é‚Šåªå– timeï¼Œtime picker æœƒè‡ªå‹•åƒ HH:mm
                        renderSchedule();
                        renderChecklist();
                    }
                    showStatus("å·²åŒæ­¥", false);
                    setTimeout(() => hideStatus(), 2000);
                } else { saveDataToCloud(true); }
            }, (error) => { console.error(error); showStatus("åŒæ­¥å¤±æ•—", true); });
        }

        function saveDataToCloud(force = false) {
            if (isEditing && !force) return;
            showStatus("å„²å­˜ä¸­...", true);
            tripDocRef.set(appData)
                .then(() => {
                    showStatus("å·²å„²å­˜è‡³é›²ç«¯", false);
                    setTimeout(() => hideStatus(), 2000);
                })
                .catch((error) => { showStatus("å„²å­˜å¤±æ•—", true); });
        }

        // --- æ¸²æŸ“èˆ‡æ‹–æ›³ ---
        function renderSchedule() {
            const container = document.getElementById('schedule-container');
            container.innerHTML = '';
            if (!appData.itinerary) appData.itinerary = {};
            const dayList = appData.itinerary[currentDay] || [];

            dayList.forEach((item, index) => {
                let cleanLoc = item.loc ? item.loc.replace(/ğŸ“|ğŸš—|ğŸš„|âœˆï¸/g, '').trim() : "";
                let mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(cleanLoc)}`;
                let hasMemo = (item.memo || "").length > 0;
                let memoDisplayClass = hasMemo ? "show" : "";

                const div = document.createElement('div');
                div.className = 'timeline-item';
                div.setAttribute('data-index', index); // ç‚ºäº†æ‹–æ›³æ’åºè­˜åˆ¥
                div.innerHTML = `
                    <div class="drag-handle"><i class="fas fa-bars"></i></div>
                    <div class="card">
                        <div class="delete-btn" onclick="deleteItem(${index})"><i class="fas fa-times"></i></div>
                        <div class="card-main">
                            <div class="time-box">
                                <input type="time" class="time-input" value="${item.time}" onchange="updateTime(${index}, this.value)">
                            </div>
                            <div class="info-box">
                                <div class="info-title" onblur="updateItinerary(${index}, 'title', this.innerText)">${item.title}</div>
                                <div class="loc-wrapper">
                                    <div class="info-loc" onblur="updateItinerary(${index}, 'loc', this.innerText)">${item.loc}</div>
                                    <a href="${mapUrl}" target="_blank" class="map-link"><i class="fas fa-location-arrow"></i> å°èˆª</a>
                                </div>
                                <div class="info-note" onblur="updateItinerary(${index}, 'note', this.innerText)">${item.note}</div>
                            </div>
                        </div>
                        <div class="memo-wrapper">
                            <div class="memo-controls">
                                ${!hasMemo ? `<div class="add-memo-btn" onclick="toggleMemo(${index}, true)">+ æ–°å¢å‚™å¿˜éŒ„</div>` : ''}
                                ${hasMemo ? `<div class="del-memo-btn" onclick="toggleMemo(${index}, false)"><i class="fas fa-trash"></i> åˆªé™¤å‚™å¿˜</div>` : ''}
                            </div>
                            <div class="memo-section ${memoDisplayClass}" onblur="updateItinerary(${index}, 'memo', this.innerText)">${item.memo || ""}</div>
                        </div>
                    </div>`;
                container.appendChild(div);
            });
            setEditable(isEditing);

            // é‡æ–°åˆå§‹åŒ–æ‹–æ›³åŠŸèƒ½ (åƒ…åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹ç”Ÿæ•ˆ)
            if (isEditing) {
                if (sortableInstance) sortableInstance.destroy(); // æ¸…é™¤èˆŠçš„
                sortableInstance = new Sortable(container, {
                    handle: '.drag-handle', // åªèƒ½æ‹‰æŠŠæ‰‹
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: function (evt) {
                        // æ‹–æ›³çµæŸï¼Œæ›´æ–°è³‡æ–™é™£åˆ—é †åº
                        const list = appData.itinerary[currentDay];
                        const item = list.splice(evt.oldIndex, 1)[0];
                        list.splice(evt.newIndex, 0, item);
                        // ä¸å­˜æª”ï¼Œç­‰æŒ‰å®Œæˆæ‰å­˜
                    }
                });
            }
        }

        function renderChecklist() {
            // (æ¸…å–®æ¸²æŸ“é‚è¼¯èˆ‡ V9 ç›¸åŒï¼Œç‚ºç¯€çœç¯‡å¹…çœç•¥ï¼Œä½†ç¨‹å¼ç¢¼ä¸­éœ€åŒ…å«)
            const container = document.getElementById('checklist-container');
            container.innerHTML = '';
            const targetList = currentChecklistType === 'pre' ? appData.checklist_pre : appData.checklist_tour;
            (targetList || []).forEach((cat, catIndex) => {
                const catDiv = document.createElement('div');
                catDiv.className = 'checklist-category';
                let itemsHtml = '';
                cat.items.forEach((item, itemIndex) => {
                    itemsHtml += `<div class="check-item ${item.checked ? 'checked' : ''}"><div class="custom-checkbox" onclick="toggleCheck(${catIndex}, ${itemIndex})"><i class="fas fa-check"></i></div><div class="item-text" onblur="updateCheckItem(${catIndex}, ${itemIndex}, this.innerText)">${item.text}</div><div class="del-check-btn" onclick="deleteCheckItem(${catIndex}, ${itemIndex})"><i class="fas fa-minus-circle"></i></div></div>`;
                });
                catDiv.innerHTML = `<div class="del-cat-btn" onclick="deleteCategory(${catIndex})">åˆªé™¤åˆ†é¡</div><div class="cat-title"><span onblur="updateCatTitle(${catIndex}, this.innerText)">${cat.category}</span></div><div class="cat-items">${itemsHtml}</div><div class="add-check-row"><div class="add-check-btn" onclick="addCheckItem(${catIndex})">+ æ–°å¢é …ç›®</div></div>`;
                container.appendChild(catDiv);
            });
            setEditable(isEditing);
        }

        // --- äº’å‹•åŠŸèƒ½ ---
        function updateTime(i, val) {
            if(appData.itinerary[currentDay][i]) appData.itinerary[currentDay][i].time = val;
        }
        function updateItinerary(i, k, v) { if(appData.itinerary[currentDay][i]) appData.itinerary[currentDay][i][k] = v.trim(); }
        function toggleMemo(i, s) { if(appData.itinerary[currentDay][i]) appData.itinerary[currentDay][i].memo = s ? "è¼¸å…¥..." : ""; renderSchedule(); }

        // æ¸…å–®èˆ‡åˆ†é¡åŠŸèƒ½ (åŒ V9)
        function toggleCheck(ci, ii) { if(isEditing) return; const list = getList(); list[ci].items[ii].checked = !list[ci].items[ii].checked; renderChecklist(); saveDataToCloud(true); }
        function updateCheckItem(c, i, v) { getList()[c].items[i].text = v.trim(); }
        function updateCatTitle(c, v) { getList()[c].category = v.trim(); }
        function addCheckItem(c) { getList()[c].items.push({ text: "æ–°é …ç›®", checked: false }); renderChecklist(); }
        function deleteCheckItem(c, i) { if(confirm('åˆªé™¤é …ç›®ï¼Ÿ')) { getList()[c].items.splice(i, 1); renderChecklist(); } }
        function addNewCategory() { getList().push({ category: "æ–°åˆ†é¡", items: [] }); renderChecklist(); }
        function deleteCategory(c) { if(confirm('åˆªé™¤åˆ†é¡ï¼Ÿ')) { getList().splice(c, 1); renderChecklist(); } }
        function getList() { return currentChecklistType === 'pre' ? appData.checklist_pre : appData.checklist_tour; }

        function toggleEditMode() {
            if (!isEditing) {
                const myPassword = "8888"; 
                if (!sessionStorage.getItem('isAuth')) {
                    const input = prompt("è«‹è¼¸å…¥ç·¨è¼¯å¯†ç¢¼ï¼š");
                    if (input === null || input !== myPassword) { alert("å¯†ç¢¼éŒ¯èª¤ï¼"); return; }
                    sessionStorage.setItem('isAuth', 'true');
                }
            } else { saveDataToCloud(true); } // å®Œæˆæ™‚å­˜æª”
            isEditing = !isEditing;
            const btnText = document.getElementById('editBtnText');
            const toggleBtn = document.querySelector('.edit-toggle');
            document.body.classList.toggle('is-editing', isEditing);
            toggleBtn.classList.toggle('editing', isEditing);
            btnText.innerText = isEditing ? 'å®Œæˆ' : 'ç·¨è¼¯';
            setEditable(isEditing);
            renderSchedule(); renderChecklist();
        }

        // é€šç”¨
        function switchDay(d, b) { currentDay = d; document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); b.classList.add('active'); renderSchedule(); }
        function switchChecklistType(t, b) { currentChecklistType = t; document.querySelectorAll('.sub-tab-btn').forEach(el => el.classList.remove('active')); b.classList.add('active'); renderChecklist(); }
        function switchPage(p, b) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); b.classList.add('active');
            document.querySelectorAll('.page-view').forEach(el => el.classList.remove('active')); document.getElementById('view-' + p).classList.add('active');
            if(p === 'itinerary') { document.getElementById('itinerary-tabs').style.display = 'flex'; document.getElementById('checklist-tabs').style.display = 'none'; }
            else { document.getElementById('itinerary-tabs').style.display = 'none'; document.getElementById('checklist-tabs').style.display = 'flex'; }
        }
        function setEditable(e) { document.querySelectorAll('.info-title, .info-loc, .info-note, .memo-section, .item-text, .cat-title span').forEach(f => { f.contentEditable = e; }); }
        function addNewItem() { if (!appData.itinerary[currentDay]) appData.itinerary[currentDay] = []; appData.itinerary[currentDay].push({ id: Date.now(), time: "12:00", title: "æ–°è¡Œç¨‹", loc: "åœ°é»", note: "å‚™è¨»", memo: "" }); renderSchedule(); }
        function deleteItem(i) { if(confirm('åˆªé™¤ï¼Ÿ')) { appData.itinerary[currentDay].splice(i, 1); renderSchedule(); } }
        function showStatus(m, e) { const el = document.getElementById('status-indicator'); el.innerHTML = e ? `<i class="fas fa-exclamation-circle"></i> ${m}` : `<i class="fas fa-check"></i> ${m}`; el.style.background = e ? 'rgba(255, 59, 48, 0.9)' : 'rgba(0,0,0,0.8)'; el.classList.add('show'); }
        function hideStatus() { document.getElementById('status-indicator').classList.remove('show'); }
        document.addEventListener('paste', function (e) { if (e.target.isContentEditable) { e.preventDefault(); const text = (e.clipboardData || window.clipboardData).getData('text'); document.execCommand('insertText', false, text); } });
    </script>
</body>
</html>
