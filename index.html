<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂêçÂè§Â±ã„ÉªÁôΩÂ∑ùÈÑâÂÜ¨ÊóÖ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* --- UI Ë®≠ÂÆö --- */
        :root {
            --primary-color: #5856D6; --bg-color: #F5F5FA; --card-bg: #FFFFFF;
            --danger-color: #FF3B30; --success-color: #34C759; --text-dark: #1C1C1E; --text-gray: #8E8E93; --line-color: #E5E5EA;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); margin: 0; padding: 0;
            padding-top: 180px; padding-bottom: 50px; -webkit-tap-highlight-color: transparent; color: var(--text-dark);
        }
        /* Header */
        .header {
            background: var(--primary-color); padding: 15px 20px 0px 20px;
            border-bottom-left-radius: 24px; border-bottom-right-radius: 24px;
            color: white; box-shadow: 0 4px 20px rgba(88, 86, 214, 0.4);
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
        }
        .header-top-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .trip-title { font-size: 24px; font-weight: 800; letter-spacing: 0.5px; line-height: 1.2; border-bottom: 1px dashed transparent; }
        .trip-subtitle { font-size: 13px; opacity: 0.8; margin-top: 4px; font-weight: 500; border-bottom: 1px dashed transparent; display: inline-block; }
        body.is-editing .trip-title, body.is-editing .trip-subtitle { border-bottom: 1px dashed rgba(255,255,255,0.5); background: rgba(0,0,0,0.1); border-radius: 4px; padding: 0 4px; }
        
        .controls { display: flex; gap: 8px; }
        .view-btn { width: 36px; height: 36px; border-radius: 12px; border: none; background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .view-btn.active { background: white; color: var(--primary-color); font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .edit-toggle { height: 36px; padding: 0 12px; border-radius: 12px; border: none; background: rgba(0,0,0,0.2); color: white; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .edit-toggle.editing { background: var(--success-color); }

        .tabs-container { padding-bottom: 15px; overflow: hidden; }
        .tabs { display: flex; overflow-x: auto; gap: 10px; scrollbar-width: none; padding: 4px; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab-btn { background: rgba(255,255,255,0.15); border: none; color: rgba(255,255,255,0.8); padding: 8px 0; border-radius: 14px; width: 60px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: white; color: var(--primary-color); font-weight: bold; transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); color: var(--primary-color) !important; }
        .tab-date { font-size: 10px; margin-bottom: 2px; }
        .tab-day { font-size: 16px; font-weight: 800; }
        .sub-tabs { display: none; justify-content: flex-start; gap: 10px; padding: 4px; }
        .sub-tab-btn { background: rgba(0,0,0,0.2); color: rgba(255,255,255,0.8); border: none; padding: 8px 20px; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .sub-tab-btn.active { background: white; color: var(--primary-color); }

        /* Content */
        .content { padding: 10px 20px; min-height: 300px; display: none; }
        .content.active { display: block; animation: fadeIn 0.3s; }
        .timeline-item { position: relative; padding-left: 20px; margin-bottom: 20px; }
        .timeline-item::before { content: ''; position: absolute; left: 9px; top: 25px; bottom: -45px; width: 2px; background: var(--line-color); }
        .timeline-item:last-child::before { display: none; }
        .timeline-item::after { content: ''; position: absolute; left: 2px; top: 25px; width: 12px; height: 12px; background: var(--primary-color); border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 2px var(--primary-color); z-index: 2; }
        .card { background: var(--card-bg); border-radius: 20px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02); display: flex; gap: 15px; position: relative; }
        
        .time-col { display: flex; flex-direction: column; align-items: center; min-width: 65px; border-right: 1px dashed #EEE; padding-right: 15px; padding-top: 5px; }
        .ampm { font-size: 11px; color: var(--text-gray); font-weight: 500; }
        .time { font-size: 18px; font-weight: 800; color: var(--text-dark); letter-spacing: -0.5px; }
        .type-badge { margin-top: 6px; padding: 3px 8px; border-radius: 8px; font-size: 10px; font-weight: 600; color: #666; background: #F2F2F7; }
        .type-select { margin-top: 6px; width: 100%; font-size: 11px; display: none; }
        body.is-editing .type-badge { display: none; }
        body.is-editing .type-select { display: block; }

        .info-col { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        .info-title { font-size: 16px; font-weight: 700; color: var(--text-dark); line-height: 1.3; }
        .info-loc { font-size: 12px; color: var(--text-gray); display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        .nav-btn { background: rgba(88, 86, 214, 0.1); color: var(--primary-color); padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; text-decoration: none; display: inline-flex; align-items: center; gap: 2px; cursor: pointer; }
        .info-note { font-size: 13px; color: #FF9500; font-weight: 500; margin-top: 2px; }
        .memo-box { margin-top: 8px; background: #FFF9E6; border-left: 3px solid #FFCC00; padding: 8px; border-radius: 6px; font-size: 12px; color: #665C3B; display: none; }
        .memo-box.show { display: block; }

        .drag-handle { position: absolute; left: -25px; top: 50%; transform: translateY(-50%); color: #CCC; font-size: 16px; display: none; cursor: grab; padding: 10px;}
        body.is-editing .drag-handle { display: block; }
        .delete-btn { position: absolute; right: -8px; top: -8px; width: 22px; height: 22px; background: var(--danger-color); color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; z-index: 10; font-size: 12px;}
        body.is-editing .delete-btn { display: flex; }

        /* Checklist */
        .checklist-container { padding: 10px 20px; }
        .checklist-category { background: white; border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .cat-title { font-weight: 700; color: var(--primary-color); border-bottom: 1px solid #EEE; padding-bottom: 8px; margin-bottom: 8px; display:flex; justify-content:space-between;}
        .check-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #FAFAFA; }
        .custom-checkbox { width: 20px; height: 20px; border: 2px solid #DDD; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .check-item.checked .custom-checkbox { background: var(--success-color); border-color: var(--success-color); }
        .check-item.checked .custom-checkbox i { color: white; font-size: 10px; display: block; }
        .custom-checkbox i { display: none; }
        .check-item.checked .item-text { text-decoration: line-through; color: #CCC; }

        /* Edit Mode Styles */
        body.is-editing .info-title, body.is-editing .info-loc span, body.is-editing .info-note, body.is-editing .time { border-bottom: 1px dashed #CCC; background: rgba(0,0,0,0.02); min-width: 20px; }
        .del-check-btn, .del-cat-btn, .add-check-row, .add-cat-btn, .add-btn-container { display: none; }
        body.is-editing .del-check-btn, body.is-editing .del-cat-btn, body.is-editing .add-check-row, body.is-editing .add-cat-btn, body.is-editing .add-btn-container { display: block; }
        .add-btn { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 30px; font-size: 13px; font-weight: 600; box-shadow: 0 4px 10px rgba(88,86,214,0.3); margin-top: 10px; }
        .add-cat-btn { width: 100%; text-align: center; padding: 15px; background: white; border: 2px dashed #DDD; border-radius: 12px; color: #AAA; margin-top: 10px; cursor: pointer;}
        .del-check-btn { color: var(--danger-color); margin-left: auto; cursor: pointer; }
        .add-check-btn { color: var(--link-color); font-size: 13px; padding-top: 5px; cursor: pointer; text-align: center;}

        #status-indicator { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 30px; font-size: 12px; z-index: 2000; display: none; }
        #status-indicator.show { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top-row">
            <div class="title-group">
                <div class="trip-title" contenteditable="false" onblur="updateTitle(this.innerText)">üáØüáµ ÂêçÂè§Â±ã„ÉªÁôΩÂ∑ùÈÑâ</div>
                <div class="trip-subtitle" contenteditable="false" onblur="updateSubtitle(this.innerText)">DEC 05 - DEC 09, 2025</div>
            </div>
            <div class="controls">
                <button id="btn-view-itinerary" class="view-btn active" onclick="switchView('itinerary')"><i class="far fa-calendar-alt"></i></button>
                <button id="btn-view-checklist" class="view-btn" onclick="switchView('checklist')"><i class="fas fa-tasks"></i></button>
                <button class="edit-toggle" onclick="toggleEditMode()"><i class="fas fa-pen"></i></button>
            </div>
        </div>
        <div class="tabs-container">
            <div id="tabs-itinerary" class="tabs">
                <button class="tab-btn active" onclick="switchDay('d1', this)"><span class="tab-date">ÈÄ±Âõõ</span><span class="tab-day">D1</span></button>
                <button class="tab-btn" onclick="switchDay('d2', this)"><span class="tab-date">ÈÄ±‰∫î</span><span class="tab-day">D2</span></button>
                <button class="tab-btn" onclick="switchDay('d3', this)"><span class="tab-date">ÈÄ±ÂÖ≠</span><span class="tab-day">D3</span></button>
                <button class="tab-btn" onclick="switchDay('d4', this)"><span class="tab-date">ÈÄ±Êó•</span><span class="tab-day">D4</span></button>
                <button class="tab-btn" onclick="switchDay('d5', this)"><span class="tab-date">ÈÄ±‰∏Ä</span><span class="tab-day">D5</span></button>
                <button class="tab-btn" onclick="switchDay('d6', this)"><span class="tab-date">ÈÄ±‰∫å</span><span class="tab-day">D6</span></button>
            </div>
            <div id="tabs-checklist" class="sub-tabs">
                <button class="sub-tab-btn active" onclick="switchChecklistType('pre', this)">üè† Ë°åÂâçÊ∫ñÂÇô</button>
                <button class="sub-tab-btn" onclick="switchChecklistType('tour', this)">üß≥ ÊóÖÈÅäÊ∏ÖÂñÆ</button>
            </div>
        </div>
    </div>

    <div id="container-itinerary" class="content active">
        <div id="schedule-container"></div>
        <div class="add-btn-container"><button class="add-btn" onclick="addNewItem()">Ôºã Êñ∞Â¢ûË°åÁ®ã</button></div>
    </div>

    <div id="container-checklist" class="content">
        <div id="checklist-container"></div>
        <div class="add-cat-btn" onclick="addNewCategory()">Ôºã Êñ∞Â¢û‰∏ÄÂÄãÂ§ßÂàÜÈ°û</div>
    </div>

    <div id="status-indicator"><i class="fas fa-sync fa-spin"></i> ÂêåÊ≠•‰∏≠...</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDTQeG0emT5pqRYwCebkyVyGttmy-t6crY",
            authDomain: "travel-d67d0.firebaseapp.com",
            projectId: "travel-d67d0",
            storageBucket: "travel-d67d0.firebasestorage.app",
            messagingSenderId: "223292356224",
            appId: "1:223292356224:web:5511095a095ffc4080d865"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // ‚òÖ Êõ¥Êñ∞Ê™îÊ°àÂêçÁ®±ÔºåÁ¢∫‰øùËºâÂÖ•Êñ∞Ë≥áÊñô ‚òÖ
        const tripDocRef = db.collection("trips").doc("nagoya_2025_trip_v15_final"); 

        // --- ÂÆåÊï¥Ë°åÁ®ãË≥áÊñô ---
        const defaultData = {
            meta: { title: "üáØüáµ ÂêçÂè§Â±ã„ÉªÁôΩÂ∑ùÈÑâ", subtitle: "DEC 05 - DEC 09, 2025" },
            itinerary: {
                d1: [
                    { id: 101, time: "11:00", type: "‚úàÔ∏è È£õË°å", title: "ÊäµÈÅîÊ°ÉÂúíÊ©üÂ†¥", loc: "Ê°ÉÂúíÊ©üÂ†¥Á¨¨‰∏ÄËà™Âªà", note: "Ê∫ñÂÇô Check-in", memo: "" },
                    { id: 102, time: "15:00", type: "‚úàÔ∏è È£õË°å", title: "È£õÂæÄ‰∏≠ÈÉ®ÂúãÈöõÁ©∫Ê∏Ø", loc: "‰∏≠ÈÉ®ÂúãÈöõÁ©∫Ê∏Ø", note: "18:30 ÊäµÈÅî", memo: "" },
                    { id: 103, time: "18:30", type: "üöÑ ‰∫§ÈÄö", title: "Âæû‰∏≠ÈÉ®ÂúãÈöõÁ©∫Ê∏Ø Âà∞ È£ØÂ∫ó", loc: "ÂêçÂè§Â±ãÂ∏ÇÂçÄ", note: "‰∫§ÈÄöÁßªÂãï", memo: "" },
                    { id: 104, time: "20:00", type: "üè® ‰ΩèÂÆø", title: "È£ØÂ∫ó Check-in", loc: "BASE LAYER Hotel", note: "ÊîæË°åÊùé„ÄÅ‰ºëÊÅØ", memo: "" },
                    { id: 105, time: "20:45", type: "üç¥ Áî®È§ê", title: "ÊôöÈ§ê / Ëá™Áî±ÊôÇÈñì", loc: "È£ØÂ∫óÈôÑËøë", note: "", memo: "" }
                ],
                d2: [
                    { id: 201, time: "07:00", type: "üè® ‰ΩèÂÆø", title: "ÈÄÄÊàø", loc: "BASE LAYER Hotel", note: "", memo: "" },
                    { id: 202, time: "07:30", type: "üöÑ ‰∫§ÈÄö", title: "JR È£õÈ©íÁâπÊÄ•ÂàóËªä", loc: "ÂêçÂè§Â±ã -> È´òÂ±±Â∏Ç", note: "ËªäÁ®ãÁ¥Ñ 2.5 Â∞èÊôÇ", memo: "" },
                    { id: 203, time: "09:30", type: "üöó ‰∫§ÈÄö", title: "ÁßüËªä", loc: "È´òÂ±±Â∏Ç", note: "Ëá™ÈßïÂâçÂæÄÁôΩÂ∑ùÈÑâ", memo: "" },
                    { id: 204, time: "10:00", type: "üöó ‰∫§ÈÄö", title: "ËªäÁ®ã", loc: "ÂæÄÁôΩÂ∑ùÈÑâ", note: "", memo: "" },
                    { id: 205, time: "11:00", type: "üç¥ Áî®È§ê", title: "‰∏≠È§ê", loc: "ÁôΩÂ∑ùÈÑâ", note: "", memo: "" },
                    { id: 206, time: "11:45", type: "üé° ÊôØÈªû", title: "ÁôΩÂ∑ùÈÑâ ÂêàÊéåÊùë", loc: "ÁôΩÂ∑ùÈÑâÂêàÊéåÊùë", note: "ËßÄÂÖâËá≥ 18:00", memo: "" },
                    { id: 207, time: "18:00", type: "üè® ‰ΩèÂÆø", title: "È£ØÂ∫ó Check-in", loc: "È´òÂ±±Âú∞ÂçÄÈ£ØÂ∫ó", note: "", memo: "" },
                    { id: 208, time: "18:30", type: "üç¥ Áî®È§ê", title: "Ëá™Áî±ÊôÇÈñì / ÊôöÈ§ê", loc: "È´òÂ±±ËÄÅË°óÂë®ÈÇä", note: "", memo: "" }
                ],
                d3: [
                    { id: 301, time: "09:00", type: "üè® ‰ΩèÂÆø", title: "ÈÄÄÊàø", loc: "È´òÂ±±È£ØÂ∫ó", note: "", memo: "" },
                    { id: 302, time: "09:30", type: "üöó ‰∫§ÈÄö", title: "ËªäÁ®ã", loc: "ÂâçÂæÄËÄÅË°ó", note: "", memo: "" },
                    { id: 303, time: "10:30", type: "üé° ÊôØÈªû", title: "È£õÈ©íÈ´òÂ±±ËÄÅË°ó", loc: "‰∏ä‰∏â‰πãÁî∫", note: "ÈÄõË°ó„ÄÅÂêÉÈ£õÈ©íÁâõÂ£ΩÂè∏", memo: "" },
                    { id: 304, time: "17:00", type: "üöó ‰∫§ÈÄö", title: "ÈÇÑËªä", loc: "È´òÂ±±ÁßüËªäÈªû", note: "", memo: "" },
                    { id: 305, time: "17:30", type: "üöÑ ‰∫§ÈÄö", title: "JR È£õÈ©íÁâπÊÄ•ÂàóËªä", loc: "È´òÂ±± -> ÂêçÂè§Â±ã", note: "ËøîÂõûÂ∏ÇÂçÄ", memo: "" },
                    { id: 306, time: "19:30", type: "üè® ‰ΩèÂÆø", title: "È£ØÂ∫ó Check-in", loc: "ÂêçÂè§Â±ãÂ∏ÇÂçÄÈ£ØÂ∫ó", note: "", memo: "" },
                    { id: 307, time: "20:00", type: "üõçÔ∏è Ë≥ºÁâ©", title: "Ëá™Áî±ÊôÇÈñì", loc: "ÂêçÂè§Â±ãËªäÁ´ôÂë®ÈÇä", note: "", memo: "" }
                ],
                d4: [
                    { id: 401, time: "08:15", type: "üé° ÊôØÈªû", title: "ÂêçÂè§Â±ãÂüé", loc: "ÂêçÂè§Â±ãÂüé", note: "ÂèÉËßÄËá≥ 10:15", memo: "" },
                    { id: 402, time: "10:15", type: "üç¥ Áî®È§ê", title: "ÈáëÈØ±Ê©´‰∏Å", loc: "ÂêçÂè§Â±ãÂüéÊóÅ", note: "ÁæéÈ£üË°óÂçàÈ§ê", memo: "" },
                    { id: 403, time: "11:30", type: "üõçÔ∏è Ë≥ºÁâ©", title: "Ê¶ÆÁî∫ -> Áü¢Â†¥Áî∫", loc: "Ê¶ÆÁî∫ÂïÜÂúà", note: "ÈÄõË°óË≥ºÁâ©", memo: "" },
                    { id: 404, time: "12:30", type: "üç¥ Áî®È§ê", title: "ÂçàÈ§ê", loc: "Ê¶ÆÁî∫", note: "", memo: "" },
                    { id: 405, time: "14:45", type: "üõçÔ∏è Ë≥ºÁâ©", title: "ÂØ∂ÂèØÂ§¢‰∏≠ÂøÉ ÂêçÂè§Â±ãÂ∫ó", loc: "Pokemon Center Nagoya", note: "ÊùæÂùÇÂ±ã", memo: "" },
                    { id: 406, time: "15:30", type: "üé° ÊôØÈªû", title: "‰∏âËº™Á•ûÁ§æ", loc: "‰∏âËº™Á•ûÁ§æ", note: "ÂÖîÂ≠êÁ•ûÁ§æ", memo: "" },
                    { id: 407, time: "17:30", type: "üõçÔ∏è Ë≥ºÁâ©", title: "Â§ßÈ†àÂïÜÂ∫óË°ó", loc: "Â§ßÈ†àÂïÜÂ∫óË°ó", note: "ÈÄõË°óÂêÉÊôöÈ§ê", memo: "" },
                    { id: 408, time: "19:45", type: "üé° ÊôØÈªû", title: "‰∏≠ÈÉ®ÈõªÂäõ MIRAI TOWER", loc: "‰πÖÂ±ãÂ§ßÈÄöÂÖ¨Âúí", note: "ÁúãÂ§úÊôØ", memo: "" }
                ],
                d5: [
                    { id: 501, time: "08:00", type: "üõçÔ∏è Ë≥ºÁâ©", title: "JR ‰∏≠Â§ÆÂ§ßÂªà", loc: "JR Central Towers", note: "ÂÖ®Êó•Ë°åÁ®ã / Ë≥ºÁâ©", memo: "" },
                    { id: 502, time: "20:00", type: "üõçÔ∏è Ë≥ºÁâ©", title: "Ëá™Áî±ÊôÇÈñì", loc: "Â∏ÇÂçÄ", note: "Êï¥ÁêÜË°åÊùé", memo: "" }
                ],
                d6: [
                    { id: 601, time: "08:30", type: "üè® ‰ΩèÂÆø", title: "ÈÄÄÊàø", loc: "ÂêçÂè§Â±ã", note: "", memo: "" },
                    { id: 602, time: "14:30", type: "üöÑ ‰∫§ÈÄö", title: "ÂâçÂæÄÊ©üÂ†¥ / Â†±Âà∞", loc: "‰∏≠ÈÉ®ÂúãÈöõÁ©∫Ê∏Ø", note: "", memo: "" },
                    { id: 603, time: "16:00", type: "üõçÔ∏è Ë≥ºÁâ©", title: "ÊäµÈÅîÊ©üÂ†¥ / ÊúÄÂæåÊé°Ë≤∑", loc: "‰∏≠ÈÉ®ÂúãÈöõÁ©∫Ê∏Ø T1", note: "", memo: "" },
                    { id: 604, time: "19:30", type: "‚úàÔ∏è È£õË°å", title: "Êê≠Ê©üËøîÂè∞", loc: "È£õË°å‰∏≠", note: "È†êË®à 22:15 ÊäµÈÅîÊ°ÉÂúí", memo: "" },
                    { id: 605, time: "22:15", type: "üè† ËøîÂÆ∂", title: "ÊäµÈÅîÊ°ÉÂúíÊ©üÂ†¥", loc: "Ê°ÉÂúíÊ©üÂ†¥", note: "Âπ≥ÂÆâÂõûÂÆ∂", memo: "" }
                ]
            },
            checklist_pre: [{ category: "ÂøÖÂÇôË≠â‰ª∂", items: [{ text: "Ë≠∑ÁÖß (ÊïàÊúü6ÂÄãÊúà‰ª•‰∏ä)", checked: false }, { text: "VJW ÂÖ•Â¢ÉÊà™Âúñ", checked: false }, { text: "Êó•Âπ£ / ‰ø°Áî®Âç°", checked: false }] }],
            checklist_tour: [{ category: "ÂøÖË≤∑‰º¥ÊâãÁ¶Æ", items: [{ text: "Ëù¶È§Ö", checked: false }, { text: "ÂêàÊéåÊùëÁ£ÅÈêµ", checked: false }] }],
            activityTypes: ["‚úàÔ∏è È£õË°å", "üöÑ ‰∫§ÈÄö", "üé° ÊôØÈªû", "üç¥ Áî®È§ê", "üè® ‰ΩèÂÆø", "üõçÔ∏è Ë≥ºÁâ©", "üöó ‰∫§ÈÄö", "üè† ËøîÂÆ∂"]
        };

        let currentDay = 'd1';
        let currentChecklistType = 'pre';
        let isEditing = false;
        let appData = JSON.parse(JSON.stringify(defaultData));
        let sortableInstance = null;

        window.onload = function() { initRealtimeSync(); };

        function initRealtimeSync() {
            showStatus("ÈÄ£Á∑ö‰∏≠...");
            tripDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const remoteData = doc.data();
                    if (!isEditing || !appData.itinerary) {
                        appData = remoteData;
                        if(!appData.meta) appData.meta = defaultData.meta;
                        if(!appData.activityTypes) appData.activityTypes = defaultData.activityTypes;
                        document.querySelector('.trip-title').innerText = appData.meta.title;
                        document.querySelector('.trip-subtitle').innerText = appData.meta.subtitle;
                        renderSchedule(); renderChecklist();
                    }
                    showStatus("Â∑≤ÂêåÊ≠•", false);
                    setTimeout(() => hideStatus(), 2000);
                } else { saveDataToCloud(true); }
            }, (error) => { console.error(error); showStatus("ÂêåÊ≠•Â§±Êïó"); });
        }

        function saveDataToCloud(force = false) {
            if (isEditing && !force) return;
            showStatus("ÂÑ≤Â≠ò‰∏≠...");
            tripDocRef.set(appData)
                .then(() => { showStatus("Â∑≤ÂÑ≤Â≠ò"); setTimeout(() => hideStatus(), 2000); })
                .catch((e) => showStatus("ÂÑ≤Â≠òÂ§±Êïó"));
        }

        function switchView(view) {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-view-' + view).classList.add('active');
            if (view === 'itinerary') {
                document.getElementById('container-itinerary').classList.add('active');
                document.getElementById('container-checklist').classList.remove('active');
                document.getElementById('tabs-itinerary').style.display = 'flex';
                document.getElementById('tabs-checklist').style.display = 'none';
            } else {
                document.getElementById('container-itinerary').classList.remove('active');
                document.getElementById('container-checklist').classList.add('active');
                document.getElementById('tabs-itinerary').style.display = 'none';
                document.getElementById('tabs-checklist').style.display = 'flex';
            }
        }

        function updateTitle(val) { appData.meta.title = val.trim(); saveDataToCloud(true); }
        function updateSubtitle(val) { appData.meta.subtitle = val.trim(); saveDataToCloud(true); }

        function getPeriod(timeStr) {
            if(!timeStr || !timeStr.includes(":")) return "";
            const h = parseInt(timeStr.split(":")[0]);
            if (h < 5) return "Ê∑±Â§ú"; if (h < 11) return "‰∏äÂçà"; if (h < 14) return "‰∏≠Âçà"; if (h < 18) return "‰∏ãÂçà"; return "Êôö‰∏ä";
        }

        function renderTypeOptions(currentVal) {
            let opts = `<option value="">ÈÅ∏ÊìáÈ°ûÂûã</option>`;
            appData.activityTypes.forEach(t => {
                const sel = t === currentVal ? 'selected' : '';
                opts += `<option value="${t}" ${sel}>${t}</option>`;
            });
            opts += `<option value="ADD_NEW">‚ûï Êñ∞Â¢ûÈÅ∏È†Ö...</option>`;
            opts += `<option value="DEL_OPTION" style="color:red;">‚ûñ Âà™Èô§ÈÅ∏È†Ö...</option>`;
            return opts;
        }

        function renderSchedule() {
            const container = document.getElementById('schedule-container');
            container.innerHTML = '';
            const dayList = appData.itinerary[currentDay] || [];

            dayList.forEach((item, index) => {
                const period = getPeriod(item.time);
                let cleanLoc = item.loc ? item.loc.replace(/üìç|üöó|üöÑ|‚úàÔ∏è/g, '').trim() : "";
                let mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(cleanLoc)}`;
                let hasMemo = (item.memo || "").length > 0;
                let memoClass = hasMemo ? "show" : "";
                let typeVal = item.type || "";
                
                const div = document.createElement('div');
                div.className = 'timeline-item';
                div.setAttribute('data-index', index);
                
                div.innerHTML = `
                    <div class="drag-handle"><i class="fas fa-bars"></i></div>
                    <div class="card">
                        <div class="delete-btn" onclick="deleteItem(${index})"><i class="fas fa-times"></i></div>
                        <div class="time-col">
                            <div class="ampm">${period}</div>
                            <div class="time" onblur="updateTimeText(${index}, this.innerText)">${item.time}</div>
                            <div class="type-badge">${typeVal}</div>
                            <select class="type-select" onchange="updateType(${index}, this.value)">${renderTypeOptions(typeVal)}</select>
                        </div>
                        <div class="info-col">
                            <div class="info-title" onblur="updateItinerary(${index}, 'title', this.innerText)">${item.title}</div>
                            <div class="info-loc">
                                <span onblur="updateLoc(${index}, this.innerText)">${item.loc}</span>
                                <a href="${mapUrl}" target="_blank" class="nav-btn"><i class="fas fa-location-arrow"></i> Â∞éËà™</a>
                            </div>
                            <div class="info-note" onblur="updateItinerary(${index}, 'note', this.innerText)">${item.note}</div>
                            <div class="memo-box ${memoClass}" onblur="updateItinerary(${index}, 'memo', this.innerText)">${item.memo || ""}</div>
                            <div class="memo-controls" style="display:none; margin-top:5px; font-size:12px;">
                                <span onclick="toggleMemo(${index})" style="color:#007AFF; cursor:pointer;">${hasMemo?'Âà™Èô§ÂÇôÂøò':'Êñ∞Â¢ûÂÇôÂøò'}</span>
                            </div>
                        </div>
                    </div>
                `;
                if(isEditing) div.querySelector('.memo-controls').style.display = 'block';
                container.appendChild(div);
            });
            setEditable(isEditing);

            if (isEditing) {
                if (sortableInstance) sortableInstance.destroy();
                sortableInstance = new Sortable(container, {
                    handle: '.drag-handle', animation: 150,
                    onEnd: function (evt) {
                        const list = appData.itinerary[currentDay];
                        const item = list.splice(evt.oldIndex, 1)[0];
                        list.splice(evt.newIndex, 0, item);
                    }
                });
            }
        }

        function updateLoc(i, v) { v = v.trim(); if(appData.itinerary[currentDay][i]) { appData.itinerary[currentDay][i].loc = v; renderSchedule(); } }
        function updateTimeText(i, val) { val = val.trim(); if(appData.itinerary[currentDay][i]) { appData.itinerary[currentDay][i].time = val; renderSchedule(); } }
        function updateItinerary(i, k, v) { if(appData.itinerary[currentDay][i]) appData.itinerary[currentDay][i][k] = v.trim(); }
        function toggleMemo(i) { const item = appData.itinerary[currentDay][i]; item.memo = item.memo ? "" : "ÂÇôÂøò..."; renderSchedule(); }
        
        function updateType(index, val) {
            if (val === "ADD_NEW") {
                const newType = prompt("Ë´ãËº∏ÂÖ•Êñ∞Ê®ôÁ±§ (‰æãÂ¶Ç: üçú ÊãâÈ∫µ)Ôºö");
                if (newType && newType.trim()) {
                    appData.activityTypes.push(newType.trim());
                    appData.itinerary[currentDay][index].type = newType.trim();
                    saveDataToCloud(true); renderSchedule();
                } else { renderSchedule(); }
            } else if (val === "DEL_OPTION") {
                const target = prompt("Ëº∏ÂÖ•Ë¶ÅÂà™Èô§ÁöÑÊ®ôÁ±§ÂêçÁ®±Ôºö");
                if (target && appData.activityTypes.includes(target)) {
                    if(confirm(`Âà™Èô§„Äå${target}„ÄçÔºü`)) {
                        appData.activityTypes = appData.activityTypes.filter(t => t !== target);
                        saveDataToCloud(true); renderSchedule();
                    }
                } else { renderSchedule(); }
            } else { appData.itinerary[currentDay][index].type = val; }
        }

        function renderChecklist() {
            const container = document.getElementById('checklist-container');
            container.innerHTML = '';
            const targetList = currentChecklistType === 'pre' ? appData.checklist_pre : appData.checklist_tour;
            (targetList || []).forEach((cat, ci) => {
                let itemsHtml = '';
                cat.items.forEach((item, ii) => {
                    itemsHtml += `<div class="check-item ${item.checked?'checked':''}"><div class="custom-checkbox" onclick="toggleCheck(${ci},${ii})"><i>‚úî</i></div><div class="item-text" onblur="updCheck(${ci},${ii},this.innerText)">${item.text}</div><div class="del-check-btn" onclick="delCheck(${ci},${ii})">‚úï</div></div>`;
                });
                const div = document.createElement('div');
                div.className = 'checklist-category';
                div.innerHTML = `<div class="cat-title"><span onblur="updCat(${ci},this.innerText)">${cat.category}</span><span class="del-cat-btn" onclick="delCat(${ci})">Âà™Èô§</span></div><div>${itemsHtml}</div><div class="add-check-row"><div class="add-check-btn" onclick="addCheck(${ci})">Ôºã Êñ∞Â¢ûÈ†ÖÁõÆ</div></div>`;
                container.appendChild(div);
            });
            setEditable(isEditing);
        }
        function toggleCheck(ci, ii) { if(isEditing) return; const l=getList(); l[ci].items[ii].checked=!l[ci].items[ii].checked; renderChecklist(); saveDataToCloud(true); }
        function updCheck(ci, ii, v) { getList()[ci].items[ii].text = v.trim(); }
        function updCat(ci, v) { getList()[ci].category = v.trim(); }
        function delCheck(ci, ii) { if(confirm('Âà™Èô§Ôºü')){ getList()[ci].items.splice(ii,1); renderChecklist(); }}
        function addCheck(ci) { getList()[ci].items.push({text:"Êñ∞È†ÖÁõÆ", checked:false}); renderChecklist(); }
        function delCat(ci) { if(confirm('Âà™Èô§ÂàÜÈ°ûÔºü')){ getList().splice(ci,1); renderChecklist(); }}
        function addNewCategory() { getList().push({category:"Êñ∞ÂàÜÈ°û", items:[]}); renderChecklist(); }
        function getList() { return currentChecklistType === 'pre' ? appData.checklist_pre : appData.checklist_tour; }

        function toggleEditMode() {
            if (!isEditing) {
                const pwd = "8888"; 
                if (!sessionStorage.getItem('isAuth')) {
                    const input = prompt("Ë´ãËº∏ÂÖ•Á∑®ËºØÂØÜÁ¢ºÔºö");
                    if (input !== pwd) { alert("ÂØÜÁ¢ºÈåØË™§"); return; }
                    sessionStorage.setItem('isAuth', 'true');
                }
            } else { saveDataToCloud(true); }
            isEditing = !isEditing;
            const btn = document.querySelector('.edit-toggle');
            document.body.classList.toggle('is-editing', isEditing);
            btn.classList.toggle('editing', isEditing);
            
            document.querySelector('.trip-title').contentEditable = isEditing;
            document.querySelector('.trip-subtitle').contentEditable = isEditing;

            setEditable(isEditing);
            renderSchedule(); renderChecklist();
        }
        
        function switchDay(d, b) { currentDay=d; document.querySelectorAll('#tabs-itinerary .tab-btn').forEach(e=>e.classList.remove('active')); b.classList.add('active'); renderSchedule(); }
        function switchChecklistType(t, b) { currentChecklistType=t; document.querySelectorAll('.sub-tab-btn').forEach(e=>e.classList.remove('active')); b.classList.add('active'); renderChecklist(); }
        function setEditable(e) { document.querySelectorAll('.info-title, .info-loc span, .info-note, .memo-box, .item-text, .cat-title span, .time').forEach(f => { f.contentEditable = e; }); }
        function addNewItem() { if(!appData.itinerary[currentDay]) appData.itinerary[currentDay]=[]; appData.itinerary[currentDay].push({id:Date.now(), time:"12:00", type:"‚úàÔ∏è È£õË°å", title:"Êñ∞Ë°åÁ®ã", loc:"Âú∞Èªû", note:"", memo:""}); renderSchedule(); }
        function deleteItem(i) { if(confirm('Âà™Èô§Ôºü')){ appData.itinerary[currentDay].splice(i,1); renderSchedule(); }}
        function showStatus(m, e){ const el=document.getElementById('status-indicator'); el.innerText=m; el.classList.add('show'); if(e) el.style.background='red'; else el.style.background='rgba(0,0,0,0.8)'; }
        function hideStatus(){ document.getElementById('status-indicator').classList.remove('show'); }
        document.addEventListener('paste', function (e) { if (e.target.isContentEditable) { e.preventDefault(); const t = (e.clipboardData || window.clipboardData).getData('text'); document.execCommand('insertText', false, t); } });
    </script>
</body>
</html>
